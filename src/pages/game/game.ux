<template>
  <div class="game-page">
    <!-- æ¸¸æˆçŠ¶æ€æ  -->
    <div class="status-bar" style="{{ responsiveStyles.statusBar }}">
      <div class="status-item status-left">
        <text class="status-label" style="{{ responsiveStyles.statusLabel }}">æ®–æ°‘è€…:</text>
        <text class="status-value" style="{{ responsiveStyles.statusValue }}">{{ (colonistData || currentCharacter) ? (colonistData || currentCharacter).name : 'æœªçŸ¥' }}</text>
      </div>
      <div class="status-item status-center">
        <text class="status-label" style="{{ responsiveStyles.statusLabel }}">ç¬¬{{ currentDay }}å¤©</text>
        <text class="status-value" style="{{ responsiveStyles.statusValue }}">{{ currentSeason }} {{ currentYear }}</text>
      </div>
      <div class="status-item status-right">
        <text class="status-label" style="{{ responsiveStyles.statusLabel }}">ä½ç½®:</text>
        <text class="status-value" style="{{ responsiveStyles.statusValue }}">{{ playerPosition.x }},{{ playerPosition.y }}</text>
      </div>
    </div>
    
    <!-- èµ„æºçŠ¶æ€æ  -->
    <div class="resource-bar" style="{{ responsiveStyles.resourceBar }}">
      <div class="resource-item">
        <text class="resource-label">é£Ÿç‰©:</text>
        <text class="resource-value">{{ resources.food }}</text>
      </div>
      <div class="resource-item">
        <text class="resource-label">é’¢é“:</text>
        <text class="resource-value">{{ resources.steel }}</text>
      </div>
      <div class="resource-item">
        <text class="resource-label">æœ¨æ:</text>
        <text class="resource-value">{{ resources.wood }}</text>
      </div>
      <div class="resource-item">
        <text class="resource-label">é“¶å¸:</text>
        <text class="resource-value">{{ resources.silver }}</text>
      </div>
    </div>
    
    <!-- ä¸»æ¸¸æˆåŒºåŸŸ - å·¦å³å¸ƒå±€ -->
    <div class="main-game-area">
      <!-- åœ°å›¾æ˜¾ç¤ºåŒºåŸŸ - ä½¿ç”¨ç‹¬ç«‹çš„mapç»„ä»¶ -->
      <div class="map-display-container" style="{{ responsiveStyles.mapContainer }}">
      <!-- è°ƒè¯•ä¿¡æ¯ï¼šåœ°å›¾æ˜¾ç¤ºå®¹å™¨ -->
      <text class="debug-info" show="{{ showDebugInfo }}">å½“å‰æ˜¯åœ°å›¾æ˜¾ç¤ºå®¹å™¨(map-display-container)</text>
      
      <!-- åœ°å›¾ç»„ä»¶å†…å®¹ -->
      <div class="map-component" style="{{ responsiveStyles.mapComponent }}">
        <!-- åœ°å½¢ç½‘æ ¼ -->
        <div class="terrain-grid" show="{{ terrainGrid && terrainGrid.length > 0 }}">
          <div class="terrain-row" for="(rowIndex, row) in terrainGrid">
            <div class="tile-container" for="(colIndex, tile) in row">
              <!-- åœ°å½¢èƒŒæ™¯ -->
               <image class="terrain-image" 
                      src="{{ getTerrainPath(tile.biome) }}" 
                      onerror="handleImageError">
               </image>
               
               <!-- åœ°å½¢ç‰¹å¾ -->
               <image class="terrain-image" 
                      src="{{ getFeaturePath(tile.hill) }}" 
                      show="{{ tile.hill && tile.hill !== '' }}"
                      onerror="handleImageError">
               </image>
              
              <!-- åœ°å½¢ç‰©ä½“ -->
              <image class="terrain-image" 
                     src="{{ getObjectPath(tile.object) }}" 
                     show="{{ tile.object && tile.object !== '' }}"
                     onerror="handleImageError">
              </image>
              
              <!-- ç©å®¶è§’è‰² -->
              <div class="player-character" 
                   show="{{ playerPosition && playerPosition.x === colIndex && playerPosition.y === rowIndex }}">
                <!-- äººç‰©èº«ä½“ -->
                <image class="player-body" 
                       src="{{ characterModel.bodyPath }}" 
                       show="{{ characterModel.bodyPath }}"
                       onerror="handleImageError">
                </image>
                
                <!-- äººç‰©å¤´éƒ¨ -->
                <image class="player-head" 
                       src="{{ characterModel.headPath }}" 
                       show="{{ characterModel.headPath }}"
                       onerror="handleImageError">
                </image>
                
                <!-- äººç‰©å¤´å‘ -->
                <image class="player-hair" 
                       src="{{ characterModel.hairPath }}" 
                       show="{{ characterModel.hairPath && characterModel.hairPath !== 'æ— ' }}"
                       onerror="handleImageError">
                </image>
                
                <!-- äººç‰©èƒ¡é¡» -->
                <image class="player-beard" 
                       src="{{ characterModel.beardPath }}" 
                       show="{{ characterModel.beardPath && characterModel.beardPath !== 'æ— ' }}"
                       onerror="handleImageError">
                </image>
                
                <!-- å¤‡ç”¨æ–‡æœ¬ç¬¦å·ï¼ˆå›¾ç‰‡åŠ è½½å¤±è´¥æ—¶æ˜¾ç¤ºï¼‰ -->
                <text class="character-symbol" show="{{ !characterModel.bodyPath }}">@</text>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- æ¸¸æˆèœå• -->
    <div class="game-menu">
      <div class="menu-item" onclick="handleMenuAction('explore')">
        <image class="menu-icon" src="/common/UI/Icons/Stars.png" onerror="handleImageError"></image>
        <text class="menu-text">æ¢ç´¢</text>
      </div>
      <div class="menu-item" onclick="handleMenuAction('build')">
        <image class="menu-icon" src="/common/UI/Icons/AutoRebuild.png" onerror="handleImageError"></image>
        <text class="menu-text">å»ºé€ </text>
      </div>
      <div class="menu-item" onclick="handleMenuAction('manage')">
        <image class="menu-icon" src="/common/UI/Icons/AutoHomeArea.png" onerror="handleImageError"></image>
        <text class="menu-text">ç®¡ç†</text>
      </div>
      <div class="menu-item" onclick="handleMenuAction('combat')">
        <image class="menu-icon" src="/common/UI/Icons/AttackMelee.png" onerror="handleImageError"></image>
        <text class="menu-text">æˆ˜æ–—</text>
      </div>
    </div>
  </div>
    

    
    <!-- åº•éƒ¨å¯¼èˆª -->
    <div class="bottom-nav" style="{{ responsiveStyles.bottomNav }}">
      <input class="nav-btn" style="{{ responsiveStyles.navBtn }}" type="button" value="é‡æ–°ç”Ÿæˆ" onclick="regenerateTerrain" />
      <input class="nav-btn" style="{{ responsiveStyles.navBtn }}" type="button" value="æ‰‹åŠ¨ä¿å­˜" onclick="saveGameWithName" />
      <input class="nav-btn {{ autoMoveEnabled ? 'auto-move-on' : 'auto-move-off' }}" style="{{ responsiveStyles.navBtn }}" type="button" value="{{ autoMoveEnabled ? 'åœæ­¢æŒ‚æœº' : 'å¼€å¯æŒ‚æœº' }}" onclick="toggleAutoMovement" />
      <input class="nav-btn test-btn" style="{{ responsiveStyles.navBtn }}" type="button" value="æµ‹è¯•" onclick="showResponsiveTest" />
      <input class="nav-btn" style="{{ responsiveStyles.navBtn }}" type="button" value="è¿”å›" onclick="goBack" />
    </div>
  </div>
</template>

<script>
import router from "@system.router"
import humanDisplay from "../../common/humanDisplay.js"
import saveManager from "../../common/saveManager.js"
import terrainGenerator from "../../common/terrainGenerator.js"
import responsiveManager from "../../common/responsiveManager.js"

export default {
  props: ['colonist', 'narrator', 'story', 'gameSettings', 'preGeneratedTerrain', 'loadFromSave', 'saveData', 'saveName'],
  private: {
    // å“åº”å¼æ ·å¼é…ç½®
    responsiveStyles: {},
    deviceInfo: {},
    
    // æ¸¸æˆåŸºç¡€ä¿¡æ¯
    gameId: '',
    gameStartTime: 0,
    currentDay: 1,
    currentSeason: 'spring',
    currentYear: 5500,
    gameTime: 0, // æ¸¸æˆå†…æ—¶é—´ï¼ˆå°æ—¶ï¼‰
    autoSaveTimer: null,
    autoMoveTimer: null,
    
    // æ¸¸æˆçŠ¶æ€
    isPaused: false,
    gameSpeed: 1, // 1=æ­£å¸¸, 2=å¿«é€Ÿ, 3=æå¿«
    autoMoveEnabled: false, // è‡ªåŠ¨ç§»åŠ¨å¼€å…³ï¼Œé»˜è®¤å…³é—­
    
    // èµ„æºç³»ç»Ÿ
    resources: {
      food: 0,
      medicine: 0,
      steel: 0,
      wood: 0,
      silver: 0,
      components: 0,
      gold: 0
    },
    
    // æ®–æ°‘åœ°çŠ¶æ€
    colonyMood: 50,
    colonyWealth: 0,
    threatLevel: 0,
    
    // åœ°å½¢ç›¸å…³æ•°æ®
    terrainGrid: [],
    currentBiome: 'TemperateForest',
    playerPosition: { x: 2, y: 2 },
    currentTileInfo: {
      biome: 'TemperateForest',
      hill: null,
      object: null
    },
    
    // äººç‰©æ¨¡å‹ç›¸å…³æ•°æ®
    currentCharacter: null,
    colonistData: null, // è§£æåçš„æ®–æ°‘è€…æ•°æ®
    narratorData: null, // è®²è¿°äººæ•°æ®
    storyData: null, // æ•…äº‹æ•°æ®
    currentDirection: 'south',
    
    // è°ƒè¯•ä¿¡æ¯æ§åˆ¶
    showDebugInfo: true, // æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
    debugTimer: null, // è°ƒè¯•ä¿¡æ¯å®šæ—¶å™¨
    
    // UIæ§åˆ¶ç›¸å…³


    characterPaths: {
      body: 'common/human/bodies/Naked_Male_south.png',
      head: 'common/human/heads/Male/Male_Average_Normal_south.png',
      hair: 'common/human/hairs/Decent_south.png',
      beard: 'common/human/beards/BeardMoustache_south.png'
    },
    
    // äººç‰©æ¨¡å‹æ•°æ®ï¼ˆç”¨äºæ¨¡æ¿ç»‘å®šï¼‰
    characterModel: {
      bodyPath: '',
      headPath: '',
      hairPath: '',
      beardPath: ''
    }
  },
  
  onInit() {
    console.log('ğŸ® æ¸¸æˆé¡µé¢å¼€å§‹åˆå§‹åŒ–...')
    
    // æ£€æŸ¥æ˜¯å¦ä»å­˜æ¡£åŠ è½½
    if (this.loadFromSave && this.saveData) {
      console.log('ğŸ“‚ æ£€æµ‹åˆ°ä»å­˜æ¡£åŠ è½½ï¼Œå¼€å§‹åŠ è½½å­˜æ¡£æ•°æ®...')
      try {
        // åˆå§‹åŒ–å“åº”å¼ç®¡ç†å™¨
        this.initResponsiveLayout()
        
        // ç«‹å³åˆå§‹åŒ–terrainGridä¸º10x10é»˜è®¤åœ°å½¢ç½‘æ ¼ï¼Œé¿å…æ¨¡æ¿æ¸²æŸ“é”™è¯¯
        this.terrainGrid = this.createDefaultTerrainGrid()
        
        // è§£æå­˜æ¡£æ•°æ®
        const gameData = typeof this.saveData === 'string' ? JSON.parse(this.saveData) : this.saveData
        console.log(`ğŸ“¥ æ­£åœ¨åŠ è½½å­˜æ¡£: ${this.saveName}`)
        
        // åŠ è½½å­˜æ¡£æ•°æ®
        this.loadGameData(gameData)
        
        // æ‰§è¡Œå¿…è¦çš„åˆå§‹åŒ–æ­¥éª¤ï¼ˆå­˜æ¡£åŠ è½½åä»éœ€è¦è¿™äº›ï¼‰
        console.log('ğŸ”§ æ‰§è¡Œå­˜æ¡£åŠ è½½åçš„å¿…è¦åˆå§‹åŒ–...')
        
        // åˆå§‹åŒ–è§’è‰²ç³»ç»Ÿï¼ˆå¦‚æœå­˜æ¡£ä¸­æœ‰è§’è‰²æ•°æ®ï¼‰
        if (gameData.currentCharacter) {
          this.initializeCharacter(gameData.currentCharacter)
          console.log('âœ… è§’è‰²ç³»ç»Ÿé‡æ–°åˆå§‹åŒ–å®Œæˆ')
        }
        
        // åˆå§‹åŒ–æ¸¸æˆè®¾ç½®
        this.initializeGameSettings()
        console.log('âœ… æ¸¸æˆè®¾ç½®é‡æ–°åˆå§‹åŒ–å®Œæˆ')
        
        // å¯åŠ¨è‡ªåŠ¨å­˜æ¡£
        this.startAutoSave()
        console.log('âœ… è‡ªåŠ¨å­˜æ¡£ç³»ç»Ÿå¯åŠ¨å®Œæˆ')
        
        // å¯åŠ¨è‡ªåŠ¨ç§»åŠ¨ï¼ˆå¦‚æœå¼€å¯ï¼‰
        if (this.autoMoveEnabled) {
          this.startAutoMovement()
          console.log('âœ… è‡ªåŠ¨ç§»åŠ¨å·²å¯åŠ¨')
        }
        
        // å¯åŠ¨è°ƒè¯•ä¿¡æ¯å®šæ—¶å™¨
        this.startDebugInfoTimer()
        
        console.log('âœ… å­˜æ¡£åŠ è½½å®Œæˆï¼Œæ¸¸æˆå·²æ¢å¤')
        return
      } catch (error) {
        console.error('âŒ å­˜æ¡£åŠ è½½å¤±è´¥:', error)
        // åŠ è½½å¤±è´¥ï¼Œç»§ç»­æ­£å¸¸åˆå§‹åŒ–æµç¨‹
      }
    }
    
    // åˆå§‹åŒ–å“åº”å¼ç®¡ç†å™¨
    this.initResponsiveLayout()
    
    // ç«‹å³åˆå§‹åŒ–terrainGridä¸º10x10é»˜è®¤åœ°å½¢ç½‘æ ¼ï¼Œé¿å…æ¨¡æ¿æ¸²æŸ“é”™è¯¯
    this.terrainGrid = this.createDefaultTerrainGrid()
    
    // éªŒè¯åˆå§‹åŒ–çš„terrainGrid
    if (!this.validateTerrainGrid(this.terrainGrid)) {
      console.error('âŒ åˆå§‹terrainGridéªŒè¯å¤±è´¥ï¼Œé‡æ–°åˆ›å»º')
      this.terrainGrid = this.createDefaultTerrainGrid()
    }
    
    console.log('âœ… åˆå§‹terrainGridåˆ›å»ºå®Œæˆ:', {
      isArray: Array.isArray(this.terrainGrid),
      length: this.terrainGrid.length,
      width: this.terrainGrid[0] ? this.terrainGrid[0].length : 0
    })
    
    // å¤„ç†æ®–æ°‘è€…æ•°æ®ï¼ˆå¯èƒ½æ˜¯å­—ç¬¦ä¸²éœ€è¦è§£æï¼‰
    let colonistData = this.colonist
    if (typeof this.colonist === 'string') {
      try {
        colonistData = JSON.parse(this.colonist)
        console.log('ğŸ“ æ®–æ°‘è€…æ•°æ®å·²ä»å­—ç¬¦ä¸²è§£æä¸ºå¯¹è±¡')
      } catch (e) {
        console.log('âŒ æ®–æ°‘è€…æ•°æ®è§£æå¤±è´¥:', e.message)
        return
      }
    }
    
    console.log('ğŸ“¥ æ¥æ”¶åˆ°æ¸¸æˆé…ç½®å‚æ•°:', {
      hasColonist: !!colonistData,
      hasNarrator: !!this.narrator,
      hasStory: !!this.story,
      hasGameSettings: !!this.gameSettings,
      hasPreGeneratedTerrain: !!this.preGeneratedTerrain,
      colonistName: colonistData?.name,
      narratorType: this.narrator?.type,
      storyType: this.story?.type
    })
    
    // å¤„ç†preGeneratedTerrainæ•°æ®ï¼ˆå¯èƒ½æ˜¯å­—ç¬¦ä¸²æ ¼å¼ï¼‰
    console.log('ğŸ” è¯¦ç»†æ£€æŸ¥æ¥æ”¶åˆ°çš„preGeneratedTerrainæ•°æ®:')
    console.log('preGeneratedTerrainå­˜åœ¨:', !!this.preGeneratedTerrain)
    console.log('preGeneratedTerrainç±»å‹:', typeof this.preGeneratedTerrain)
    
    // å¦‚æœpreGeneratedTerrainæ˜¯å­—ç¬¦ä¸²ï¼Œå°è¯•è§£æä¸ºJSONå¯¹è±¡
    if (this.preGeneratedTerrain && typeof this.preGeneratedTerrain === 'string') {
      try {
        console.log('ğŸ”„ å°è¯•è§£æpreGeneratedTerrainå­—ç¬¦ä¸²ä¸ºJSONå¯¹è±¡')
        this.preGeneratedTerrain = JSON.parse(this.preGeneratedTerrain)
        console.log('âœ… preGeneratedTerrainè§£ææˆåŠŸï¼Œç±»å‹:', typeof this.preGeneratedTerrain)
      } catch (error) {
        console.error('âŒ preGeneratedTerrain JSONè§£æå¤±è´¥:', error)
        this.preGeneratedTerrain = null
      }
    }
    
    if (this.preGeneratedTerrain) {
      console.log('preGeneratedTerrainå±æ€§:', Object.keys(this.preGeneratedTerrain))
      console.log('gridå­˜åœ¨:', !!this.preGeneratedTerrain.grid)
      console.log('gridç±»å‹:', typeof this.preGeneratedTerrain.grid)
      console.log('gridæ˜¯æ•°ç»„:', Array.isArray(this.preGeneratedTerrain.grid))
      console.log('biomeå­˜åœ¨:', !!this.preGeneratedTerrain.biome)
      console.log('biomeå€¼:', this.preGeneratedTerrain.biome)
      console.log('playerPositionå­˜åœ¨:', !!this.preGeneratedTerrain.playerPosition)
      console.log('playerPositionå€¼:', this.preGeneratedTerrain.playerPosition)
      console.log('terrainGridå­˜åœ¨:', !!this.preGeneratedTerrain.terrainGrid)
      
      if (this.preGeneratedTerrain.grid && Array.isArray(this.preGeneratedTerrain.grid)) {
        console.log('gridé•¿åº¦:', this.preGeneratedTerrain.grid.length)
        if (this.preGeneratedTerrain.grid.length > 0) {
          console.log('grid[0]é•¿åº¦:', this.preGeneratedTerrain.grid[0].length)
          console.log('grid[0][0]ç¤ºä¾‹:', this.preGeneratedTerrain.grid[0][0])
        }
      }
    } else {
      console.log('âŒ preGeneratedTerrainä¸ºç©ºæˆ–æœªå®šä¹‰')
    }
    
    // éªŒè¯å…³é”®æ•°æ®
    if (!colonistData) {
      console.log('âŒ æ¸¸æˆåˆå§‹åŒ–å¤±è´¥: æ®–æ°‘è€…æ•°æ®ç¼ºå¤±')
      return
    }
    
    if (!this.narrator) {
      console.log('âŒ æ¸¸æˆåˆå§‹åŒ–å¤±è´¥: è®²è¿°äººæ•°æ®ç¼ºå¤±')
      return
    }
    
    if (!this.story) {
      console.log('âŒ æ¸¸æˆåˆå§‹åŒ–å¤±è´¥: æ•…äº‹æ•°æ®ç¼ºå¤±')
      return
    }
    
    // å°†è§£æåçš„æ•°æ®ä¿å­˜åˆ°å®ä¾‹
    this.colonistData = colonistData
    this.narratorData = this.narrator
    this.storyData = this.story
    // æ³¨æ„ï¼špreGeneratedTerrain åº”è¯¥ä» props ä¸­è·å–ï¼Œè¿™é‡Œä¸éœ€è¦é‡æ–°èµ‹å€¼
    // this.preGeneratedTerrain å·²ç»é€šè¿‡ props ä¼ å…¥
    
    console.log('âœ… æ¸¸æˆé…ç½®éªŒè¯é€šè¿‡ï¼Œå¼€å§‹åˆå§‹åŒ–æ¸¸æˆç»„ä»¶...')
    
    try {
      // åˆå§‹åŒ–æ¸¸æˆçŠ¶æ€
      this.gameId = 'game_' + Date.now()
      this.gameStartTime = Date.now()
      
      // åˆå§‹åŒ–èµ„æºï¼ˆæ ¹æ®æ•…äº‹ç±»å‹ï¼‰
      this.initializeResources()
      console.log('âœ… èµ„æºç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ')
      
      // åˆå§‹åŒ–äººç‰©æ¨¡å‹ï¼ˆä½¿ç”¨ä¼ å…¥çš„è§’è‰²æ•°æ®ï¼‰
      this.initializeCharacter(colonistData)
      console.log('âœ… è§’è‰²ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ')
      
      // åŠ è½½é¢„ç”Ÿæˆçš„åœ°å›¾æ•°æ®æˆ–ç”Ÿæˆæ–°åœ°å›¾
      this.initializeTerrain()
      
      // å¦‚æœåœ°å›¾åˆå§‹åŒ–å¤±è´¥ï¼Œåˆ™ä½¿ç”¨é»˜è®¤åœ°å½¢ä½œä¸ºå¤‡ç”¨
      if (!this.terrainGrid || this.terrainGrid.length === 0) {
        console.log('ğŸ”„ åœ°å›¾åˆå§‹åŒ–å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤åœ°å½¢')
        this.initializeDefaultTerrain()
      }
      
      // ç¡®ä¿ç©å®¶ä½ç½®åœ¨åœ°å›¾ä¸­å¤®
      this.ensurePlayerCenterPosition()
      
      // åˆå§‹åŒ–æ¸¸æˆè®¾ç½®
      this.initializeGameSettings()
      console.log('âœ… æ¸¸æˆè®¾ç½®åˆå§‹åŒ–å®Œæˆ')
      
      // å¯åŠ¨è‡ªåŠ¨å­˜æ¡£
      this.startAutoSave()
      
      // å¯åŠ¨è‡ªåŠ¨ç§»åŠ¨ï¼ˆæŒ‚æœºæ¨¡å¼ï¼‰- ä»…åœ¨å¼€å…³å¼€å¯æ—¶å¯åŠ¨
      if (this.autoMoveEnabled) {
        this.startAutoMovement()
        console.log('âœ… è‡ªåŠ¨ç§»åŠ¨å·²å¯åŠ¨')
      } else {
        console.log('â„¹ï¸ è‡ªåŠ¨ç§»åŠ¨å·²ç¦ç”¨ï¼Œå¦‚éœ€å¯ç”¨è¯·ä¿®æ”¹æ¸¸æˆè®¾ç½®')
      }
      
      // åˆ›å»ºåˆå§‹å­˜æ¡£
      this.createInitialSave()
      console.log('âœ… åˆå§‹å­˜æ¡£åˆ›å»ºå®Œæˆ')
      

      
      // å¯åŠ¨è°ƒè¯•ä¿¡æ¯å®šæ—¶å™¨ï¼ˆ10ç§’åéšè—ï¼‰
      this.startDebugInfoTimer()
      
      console.log('ğŸ‰ æ¸¸æˆåˆå§‹åŒ–å…¨éƒ¨å®Œæˆï¼')
    } catch (error) {
      console.log('âŒ æ¸¸æˆåˆå§‹åŒ–è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯:', error.message)
    }
  },
  
  onDestroy() {
    if (this.autoSaveTimer) {
      clearInterval(this.autoSaveTimer)
      this.autoSaveTimer = null
    }
    if (this.autoMoveTimer) {
      clearInterval(this.autoMoveTimer)
      this.autoMoveTimer = null
    }

    if (this.debugTimer) {
      clearTimeout(this.debugTimer)
      this.debugTimer = null
    }
  },
  
  // åˆ›å»ºé»˜è®¤çš„10x10åœ°å½¢ç½‘æ ¼
  createDefaultTerrainGrid() {
    console.log('ğŸ—ï¸ åˆ›å»ºé»˜è®¤10x10åœ°å½¢ç½‘æ ¼...')
    const grid = []
    for (let y = 0; y < 10; y++) {
      grid[y] = []
      for (let x = 0; x < 10; x++) {
        grid[y][x] = {
          biome: 'TemperateForest',
          hill: null,
          object: null
        }
      }
    }
    return grid
  },
  
  // éªŒè¯åœ°å½¢ç½‘æ ¼çš„æœ‰æ•ˆæ€§
  validateTerrainGrid(grid) {
    if (!grid || !Array.isArray(grid)) {
      console.error('âŒ terrainGridä¸æ˜¯æ•°ç»„')
      return false
    }
    
    if (grid.length === 0) {
      console.error('âŒ terrainGridä¸ºç©ºæ•°ç»„')
      return false
    }
    
    for (let y = 0; y < grid.length; y++) {
      if (!grid[y] || !Array.isArray(grid[y])) {
        console.error(`âŒ terrainGrid[${y}]ä¸æ˜¯æ•°ç»„`)
        return false
      }
      
      if (grid[y].length === 0) {
        console.error(`âŒ terrainGrid[${y}]ä¸ºç©ºæ•°ç»„`)
        return false
      }
      
      for (let x = 0; x < grid[y].length; x++) {
        const tile = grid[y][x]
        if (!tile || typeof tile !== 'object') {
          console.error(`âŒ terrainGrid[${y}][${x}]ä¸æ˜¯æœ‰æ•ˆçš„åœ°å—å¯¹è±¡`)
          return false
        }
        
        if (!tile.biome || typeof tile.biome !== 'string') {
          console.error(`âŒ terrainGrid[${y}][${x}].biomeæ— æ•ˆ`)
          return false
        }
      }
    }
    
    return true
  },
  
  // å®‰å…¨è·å–åœ°å—ä¿¡æ¯
  getTileAt(x, y) {
    if (!this.validateTerrainGrid(this.terrainGrid)) {
      console.error('âŒ terrainGridæ— æ•ˆï¼Œæ— æ³•è·å–åœ°å—ä¿¡æ¯')
      return null
    }
    
    if (y < 0 || y >= this.terrainGrid.length || x < 0 || x >= this.terrainGrid[y].length) {
      console.error(`âŒ åæ ‡(${x}, ${y})è¶…å‡ºåœ°å›¾èŒƒå›´`)
      return null
    }
    
    return this.terrainGrid[y][x]
  },
  
  // å®‰å…¨è®¾ç½®åœ°å—ä¿¡æ¯
  setTileAt(x, y, tile) {
    if (!this.validateTerrainGrid(this.terrainGrid)) {
      console.error('âŒ terrainGridæ— æ•ˆï¼Œæ— æ³•è®¾ç½®åœ°å—ä¿¡æ¯')
      return false
    }
    
    if (y < 0 || y >= this.terrainGrid.length || x < 0 || x >= this.terrainGrid[y].length) {
      console.error(`âŒ åæ ‡(${x}, ${y})è¶…å‡ºåœ°å›¾èŒƒå›´`)
      return false
    }
    
    if (!tile || typeof tile !== 'object' || !tile.biome) {
      console.error('âŒ æ— æ•ˆçš„åœ°å—æ•°æ®')
      return false
    }
    
    this.terrainGrid[y][x] = tile
    return true
  },
  
  // åˆå§‹åŒ–é»˜è®¤åœ°å½¢ç½‘æ ¼
  initializeDefaultTerrain() {
    console.log('ğŸ”„ å¼€å§‹ä½¿ç”¨é»˜è®¤åœ°å½¢åˆå§‹åŒ–...')
    console.log('âš ï¸ è§¦å‘åŸå› : åœ°å½¢ç”Ÿæˆå¤±è´¥æˆ–æ— æœ‰æ•ˆåœ°å½¢æ•°æ®')
    
    const startTime = Date.now()
    
    // ä½¿ç”¨å®‰å…¨æ–¹æ³•åˆ›å»º10x10çš„é»˜è®¤åœ°å½¢ç½‘æ ¼
    this.terrainGrid = this.createDefaultTerrainGrid()
    
    // éªŒè¯åˆ›å»ºçš„åœ°å½¢ç½‘æ ¼
    if (!this.validateTerrainGrid(this.terrainGrid)) {
      console.error('âŒ é»˜è®¤åœ°å½¢ç½‘æ ¼åˆ›å»ºå¤±è´¥ï¼Œå°è¯•é‡æ–°åˆ›å»º')
      this.terrainGrid = this.createDefaultTerrainGrid()
      
      if (!this.validateTerrainGrid(this.terrainGrid)) {
        console.error('âŒ é‡æ–°åˆ›å»ºé»˜è®¤åœ°å½¢ç½‘æ ¼ä»ç„¶å¤±è´¥')
        return
      }
    }
    
    const createTime = Date.now() - startTime
    const tileCount = this.terrainGrid.length * this.terrainGrid[0].length
    
    console.log('ğŸ—ºï¸ é»˜è®¤åœ°å½¢ç½‘æ ¼åˆ›å»ºå®Œæˆ:', {
      gridSize: `${this.terrainGrid.length}x${this.terrainGrid[0].length}`,
      totalTiles: tileCount,
      createTime: `${createTime}ms`,
      isValid: this.validateTerrainGrid(this.terrainGrid)
    })
    
    // è®¾ç½®é»˜è®¤ç”Ÿç‰©ç¾¤ç³»
    this.currentBiome = 'TemperateForest'
    console.log('ğŸŒ² é»˜è®¤ç”Ÿç‰©ç¾¤ç³»è®¾ç½®:', this.currentBiome)
    
    // è¯¦ç»†æ—¥å¿—ï¼šæ£€æŸ¥é»˜è®¤åœ°å½¢èµ„æºè·¯å¾„
    console.log('ğŸ” éªŒè¯é»˜è®¤åœ°å½¢èµ„æºè·¯å¾„...')
    console.log('ğŸŒ² é»˜è®¤ç”Ÿç‰©ç¾¤ç³»è·¯å¾„éªŒè¯:', {
      biome: 'TemperateForest',
      note: 'è·¯å¾„éªŒè¯å·²ç§»è‡³mapç»„ä»¶'
    })
    
    // è®¾ç½®ç©å®¶ä½ç½®åœ¨åœ°å›¾ä¸­å¤®
    const centerX = Math.floor(this.terrainGrid[0].length / 2)
    const centerY = Math.floor(this.terrainGrid.length / 2)
    this.playerPosition = { x: centerX, y: centerY }
    console.log('ğŸ‘¤ é»˜è®¤ç©å®¶ä½ç½®è®¾ç½®ï¼ˆåœ°å›¾ä¸­å¤®ï¼‰:', {
      position: this.playerPosition,
      gridCenter: `(${centerX}, ${centerY})`,
      isValidPosition: this.playerPosition.x >= 0 && this.playerPosition.x < this.terrainGrid[0].length &&
                      this.playerPosition.y >= 0 && this.playerPosition.y < this.terrainGrid.length
    })
    
    // åŒæ­¥åˆ°terrainGenerator
    console.log('ğŸ”„ åŒæ­¥é»˜è®¤åœ°å½¢åˆ°terrainGenerator...')
    if (terrainGenerator) {
      terrainGenerator.currentTerrain = {
        grid: this.terrainGrid,
        biome: this.currentBiome,
        playerPosition: this.playerPosition
      }
      console.log('âœ… é»˜è®¤åœ°å½¢å·²åŒæ­¥åˆ°terrainGenerator:', {
        hasGrid: !!terrainGenerator.currentTerrain.grid,
        biome: terrainGenerator.currentTerrain.biome,
        playerPosition: terrainGenerator.currentTerrain.playerPosition
      })
    } else {
      console.log('âš ï¸ terrainGeneratorä¸å­˜åœ¨ï¼Œè·³è¿‡åŒæ­¥')
    }
    
    // æ›´æ–°å½“å‰åœ°å—ä¿¡æ¯
    console.log('ğŸ”„ æ›´æ–°å½“å‰åœ°å—ä¿¡æ¯...')
    this.updateCurrentTileInfo()
    
    const totalTime = Date.now() - startTime
    console.log('âœ… é»˜è®¤åœ°å½¢åˆå§‹åŒ–å®Œæˆ:', {
      totalTime: `${totalTime}ms`,
      finalGridSize: `${this.terrainGrid.length}x${this.terrainGrid[0].length}`,
      finalPlayerPosition: this.playerPosition,
      finalBiome: this.currentBiome
    })
  },
  
  // åœ°å½¢åˆå§‹åŒ–æ–¹æ³•ï¼ˆä¼˜å…ˆä½¿ç”¨é¢„ç”Ÿæˆçš„åœ°å›¾ï¼‰
  initializeTerrain() {
    console.log('ğŸš€ å¼€å§‹åœ°å½¢åˆå§‹åŒ–æµç¨‹...')
    
    try {
      // è¯¦ç»†æ£€æŸ¥é¢„ç”Ÿæˆåœ°å›¾æ•°æ®çš„å®Œæ•´æ€§
      console.log('ğŸ” æ£€æŸ¥é¢„ç”Ÿæˆåœ°å›¾æ•°æ®:', {
        hasPreGeneratedTerrain: !!this.preGeneratedTerrain,
        hasGrid: !!(this.preGeneratedTerrain && this.preGeneratedTerrain.grid),
        hasBiome: !!(this.preGeneratedTerrain && this.preGeneratedTerrain.biome),
        hasPlayerPosition: !!(this.preGeneratedTerrain && this.preGeneratedTerrain.playerPosition)
      })
      
      if (this.preGeneratedTerrain && this.preGeneratedTerrain.grid) {
        console.log('ğŸ—ºï¸ å‘ç°é¢„ç”Ÿæˆçš„åœ°å›¾æ•°æ®ï¼Œå¼€å§‹éªŒè¯å’ŒåŠ è½½...')
        
        // éªŒè¯é¢„ç”Ÿæˆåœ°å›¾æ•°æ®çš„å®Œæ•´æ€§
        const grid = this.preGeneratedTerrain.grid
        const biome = this.preGeneratedTerrain.biome
        const playerPos = this.preGeneratedTerrain.playerPosition
        
        console.log('ğŸ“Š é¢„ç”Ÿæˆåœ°å›¾æ•°æ®è¯¦æƒ…:', {
          gridType: typeof grid,
          gridLength: grid ? grid.length : 0,
          gridWidth: grid && grid[0] ? grid[0].length : 0,
          biome: biome,
          playerPosition: playerPos,
          firstTile: grid && grid[0] && grid[0][0] ? grid[0][0] : null
        })
        
        // éªŒè¯ç½‘æ ¼æ•°æ®
        if (!Array.isArray(grid) || grid.length === 0) {
          throw new Error('é¢„ç”Ÿæˆåœ°å›¾ç½‘æ ¼æ•°æ®æ— æ•ˆ')
        }
        
        // éªŒè¯ç©å®¶ä½ç½®
        if (!playerPos || typeof playerPos.x !== 'number' || typeof playerPos.y !== 'number') {
          throw new Error('é¢„ç”Ÿæˆåœ°å›¾ç©å®¶ä½ç½®æ•°æ®æ— æ•ˆ')
        }
        
        // éªŒè¯ç©å®¶ä½ç½®æ˜¯å¦åœ¨ç½‘æ ¼èŒƒå›´å†…
        if (playerPos.x < 0 || playerPos.x >= grid[0].length || playerPos.y < 0 || playerPos.y >= grid.length) {
          console.log('âš ï¸ ç©å®¶ä½ç½®è¶…å‡ºç½‘æ ¼èŒƒå›´ï¼Œé‡ç½®åˆ°ä¸­å¿ƒä½ç½®')
          playerPos.x = Math.floor(grid[0].length / 2)
          playerPos.y = Math.floor(grid.length / 2)
        }
        
        console.log('âœ… é¢„ç”Ÿæˆåœ°å›¾æ•°æ®éªŒè¯é€šè¿‡ï¼Œå¼€å§‹åº”ç”¨æ•°æ®...')
        
        // ä½¿ç”¨é¢„ç”Ÿæˆçš„åœ°å›¾æ•°æ®
        this.terrainGrid = grid
        this.currentBiome = biome || 'TemperateForest'
        this.playerPosition = { ...playerPos }
        
        console.log('ğŸ”„ åŒæ­¥åœ°å½¢æ•°æ®åˆ°terrainGenerator...')
        
        // åŒæ­¥æ›´æ–°terrainGeneratorä¸­çš„åœ°å½¢æ•°æ®
        terrainGenerator.currentTerrain = {
          grid: this.terrainGrid,
          biome: this.currentBiome,
          playerPosition: this.playerPosition
        }
        
        console.log('âœ… é¢„ç”Ÿæˆåœ°å›¾åŠ è½½å®Œæˆ:', {
      biome: this.currentBiome,
      playerPosition: this.playerPosition,
      gridSize: `${this.terrainGrid.length}x${this.terrainGrid[0].length}`,
      totalTiles: this.terrainGrid.length * this.terrainGrid[0].length
    })
    
    // éªŒè¯åœ°å›¾æ¸²æŸ“æ•°æ®
    console.log('ğŸ” å¼€å§‹éªŒè¯åœ°å›¾æ¸²æŸ“æ•°æ®...')
    this.validateMapRendering()
        
        // éªŒè¯åŠ è½½åçš„æ•°æ®
        this.validateLoadedTerrain()
        
      } else {
        console.log('ğŸ—ºï¸ æœªå‘ç°é¢„ç”Ÿæˆåœ°å›¾æ•°æ®ï¼Œå¼€å§‹ç”Ÿæˆæ–°åœ°å›¾...')
        console.log('ğŸ“ é¢„ç”Ÿæˆåœ°å›¾ç¼ºå¤±åŸå› :', {
          noPreGeneratedTerrain: !this.preGeneratedTerrain,
          noGrid: this.preGeneratedTerrain && !this.preGeneratedTerrain.grid
        })
        this.generateTerrain()
      }
    } catch (error) {
      console.log('âŒ åœ°å›¾åˆå§‹åŒ–å¤±è´¥:', {
        errorMessage: error.message,
        errorStack: error.stack,
        preGeneratedTerrainExists: !!this.preGeneratedTerrain
      })
      console.log('ğŸ”„ å›é€€åˆ°é»˜è®¤åœ°å½¢ç”Ÿæˆ')
      this.initializeDefaultTerrain()
    }
    
    console.log('ğŸ¯ æ›´æ–°å½“å‰åœ°å—ä¿¡æ¯...')
    this.updateCurrentTileInfo()
    console.log('âœ… åœ°å½¢åˆå§‹åŒ–æµç¨‹å®Œæˆ')
  },
  
  // éªŒè¯åŠ è½½åçš„åœ°å½¢æ•°æ®
  validateLoadedTerrain() {
    console.log('ğŸ” å¼€å§‹éªŒè¯åŠ è½½åçš„åœ°å½¢æ•°æ®...')
    
    try {
      // éªŒè¯åŸºæœ¬æ•°æ®ç»“æ„
      if (!this.terrainGrid || !Array.isArray(this.terrainGrid)) {
        throw new Error('åœ°å½¢ç½‘æ ¼æ•°æ®ç»“æ„æ— æ•ˆ')
      }
      
      if (!this.currentBiome || typeof this.currentBiome !== 'string') {
        throw new Error('å½“å‰ç”Ÿç‰©ç¾¤ç³»æ•°æ®æ— æ•ˆ')
      }
      
      if (!this.playerPosition || typeof this.playerPosition.x !== 'number' || typeof this.playerPosition.y !== 'number') {
        throw new Error('ç©å®¶ä½ç½®æ•°æ®æ— æ•ˆ')
      }
      
      // éªŒè¯ç½‘æ ¼å†…å®¹
      let validTiles = 0
      let invalidTiles = 0
      const biomeTypes = new Set()
      const hillTypes = new Set()
      const objectTypes = new Set()
      
      for (let y = 0; y < this.terrainGrid.length; y++) {
        if (!Array.isArray(this.terrainGrid[y])) {
          throw new Error(`åœ°å½¢ç½‘æ ¼ç¬¬${y}è¡Œæ•°æ®ç»“æ„æ— æ•ˆ`)
        }
        
        for (let x = 0; x < this.terrainGrid[y].length; x++) {
          const tile = this.terrainGrid[y][x]
          
          if (!tile || typeof tile !== 'object') {
            invalidTiles++
            console.log(`âš ï¸ åœ°å—[${x},${y}]æ•°æ®æ— æ•ˆ:`, tile)
            continue
          }
          
          if (!tile.biome || typeof tile.biome !== 'string') {
            invalidTiles++
            console.log(`âš ï¸ åœ°å—[${x},${y}]ç”Ÿç‰©ç¾¤ç³»æ•°æ®æ— æ•ˆ:`, tile.biome)
            continue
          }
          
          validTiles++
          biomeTypes.add(tile.biome)
          if (tile.hill) hillTypes.add(tile.hill)
          if (tile.object) objectTypes.add(tile.object)
        }
      }
      
      console.log('ğŸ“Š åœ°å½¢æ•°æ®éªŒè¯ç»“æœ:', {
        totalTiles: validTiles + invalidTiles,
        validTiles: validTiles,
        invalidTiles: invalidTiles,
        validationRate: `${((validTiles / (validTiles + invalidTiles)) * 100).toFixed(1)}%`,
        uniqueBiomes: biomeTypes.size,
        uniqueHills: hillTypes.size,
        uniqueObjects: objectTypes.size,
        biomeList: Array.from(biomeTypes),
        hillList: Array.from(hillTypes),
        objectList: Array.from(objectTypes)
      })
      
      // éªŒè¯å½“å‰ç©å®¶ä½ç½®çš„åœ°å—
      const currentTile = this.terrainGrid[this.playerPosition.y] && this.terrainGrid[this.playerPosition.y][this.playerPosition.x]
      if (!currentTile) {
        throw new Error(`ç©å®¶å½“å‰ä½ç½®[${this.playerPosition.x},${this.playerPosition.y}]çš„åœ°å—æ•°æ®ä¸å­˜åœ¨`)
      }
      
      console.log('ğŸ“ å½“å‰ç©å®¶ä½ç½®åœ°å—éªŒè¯:', {
        position: this.playerPosition,
        tile: currentTile,
        biome: currentTile.biome,
        hill: currentTile.hill || 'æ— ',
        object: currentTile.object || 'æ— '
      })
      
      if (invalidTiles > 0) {
        console.log(`âš ï¸ å‘ç°${invalidTiles}ä¸ªæ— æ•ˆåœ°å—ï¼Œä½†åœ°å½¢æ•°æ®åŸºæœ¬å¯ç”¨`)
      } else {
        console.log('âœ… åœ°å½¢æ•°æ®éªŒè¯å®Œå…¨é€šè¿‡')
      }
      
    } catch (error) {
      console.log('âŒ åœ°å½¢æ•°æ®éªŒè¯å¤±è´¥:', {
        errorMessage: error.message,
        terrainGridType: typeof this.terrainGrid,
        terrainGridLength: this.terrainGrid ? this.terrainGrid.length : 0,
        currentBiome: this.currentBiome,
        playerPosition: this.playerPosition
      })
      throw error
    }
  },
  
  // åœ°å½¢ç”Ÿæˆç›¸å…³æ–¹æ³•
  generateTerrain() {
    console.log('ğŸ² å¼€å§‹éšæœºåœ°å½¢ç”Ÿæˆæµç¨‹...')
    
    try {
      console.log('ğŸ”§ è°ƒç”¨terrainGenerator.generateTerrain()...')
      const startTime = Date.now()
      const terrain = terrainGenerator.generateTerrain()
      const generateTime = Date.now() - startTime
      
      console.log('â±ï¸ åœ°å½¢ç”Ÿæˆè€—æ—¶:', `${generateTime}ms`)
      
      if (!terrain) {
        throw new Error('terrainGeneratorè¿”å›ç©ºæ•°æ®')
      }
      
      console.log('ğŸ“Š ç”Ÿæˆçš„åœ°å½¢æ•°æ®ç»“æ„:', {
        hasGrid: !!terrain.grid,
        hasBiome: !!terrain.biome,
        hasPlayerPosition: !!terrain.playerPosition,
        gridType: typeof terrain.grid,
        biomeType: typeof terrain.biome,
        playerPositionType: typeof terrain.playerPosition
      })
      
      if (!terrain.grid || !Array.isArray(terrain.grid)) {
        throw new Error('ç”Ÿæˆçš„åœ°å½¢ç½‘æ ¼æ•°æ®æ— æ•ˆ')
      }
      
      if (!terrain.biome || typeof terrain.biome !== 'string') {
        throw new Error('ç”Ÿæˆçš„ç”Ÿç‰©ç¾¤ç³»æ•°æ®æ— æ•ˆ')
      }
      
      if (!terrain.playerPosition || typeof terrain.playerPosition.x !== 'number' || typeof terrain.playerPosition.y !== 'number') {
        throw new Error('ç”Ÿæˆçš„ç©å®¶ä½ç½®æ•°æ®æ— æ•ˆ')
      }
      
      console.log('âœ… åœ°å½¢æ•°æ®ç»“æ„éªŒè¯é€šè¿‡ï¼Œå¼€å§‹åº”ç”¨æ•°æ®...')
      
      this.terrainGrid = terrain.grid
      this.currentBiome = terrain.biome
      this.playerPosition = { ...terrain.playerPosition }
      
      console.log('ğŸ—ºï¸ åœ°å½¢æ•°æ®åº”ç”¨å®Œæˆ:', {
        biome: this.currentBiome,
        playerPosition: this.playerPosition,
        gridSize: `${this.terrainGrid.length}x${this.terrainGrid[0].length}`,
        totalTiles: this.terrainGrid.length * this.terrainGrid[0].length
      })
      
      // è¯¦ç»†æ—¥å¿—ï¼šåˆ†æåœ°å½¢ç»„æˆ
      console.log('ğŸ” å¼€å§‹åˆ†æåœ°å½¢ç»„æˆ...')
      const biomeCount = {}
      const hillCount = {}
      const objectCount = {}
      let tilesWithHills = 0
      let tilesWithObjects = 0
      
      for (let y = 0; y < this.terrainGrid.length; y++) {
        for (let x = 0; x < this.terrainGrid[y].length; x++) {
          const tile = this.terrainGrid[y][x]
          
          // ç»Ÿè®¡ç”Ÿç‰©ç¾¤ç³»
          biomeCount[tile.biome] = (biomeCount[tile.biome] || 0) + 1
          
          // ç»Ÿè®¡å±±ä¸˜
          if (tile.hill) {
            tilesWithHills++
            hillCount[tile.hill] = (hillCount[tile.hill] || 0) + 1
          }
          
          // ç»Ÿè®¡ç‰©ä½“
          if (tile.object) {
            tilesWithObjects++
            objectCount[tile.object] = (objectCount[tile.object] || 0) + 1
          }
        }
      }
      
      console.log('ğŸ“ˆ åœ°å½¢ç»„æˆç»Ÿè®¡:', {
        ç”Ÿç‰©ç¾¤ç³»åˆ†å¸ƒ: biomeCount,
        å±±ä¸˜åˆ†å¸ƒ: hillCount,
        ç‰©ä½“åˆ†å¸ƒ: objectCount,
        å±±ä¸˜è¦†ç›–ç‡: `${((tilesWithHills / (this.terrainGrid.length * this.terrainGrid[0].length)) * 100).toFixed(1)}%`,
        ç‰©ä½“è¦†ç›–ç‡: `${((tilesWithObjects / (this.terrainGrid.length * this.terrainGrid[0].length)) * 100).toFixed(1)}%`
      })
      
      // è¯¦ç»†æ—¥å¿—ï¼šæ£€æŸ¥å‰9ä¸ªåœ°å—çš„åŸºæœ¬ä¿¡æ¯
      console.log('ğŸ—ºï¸ æ£€æŸ¥å‰9ä¸ªåœ°å—çš„åŸºæœ¬ä¿¡æ¯:')
      for (let y = 0; y < Math.min(3, this.terrainGrid.length); y++) {
        for (let x = 0; x < Math.min(3, this.terrainGrid[y].length); x++) {
          const tile = this.terrainGrid[y][x]
          
          console.log(`ğŸ“ åœ°å—[${x},${y}]:`, {
            biome: tile.biome,
            hill: tile.hill || 'æ— ',
            object: tile.object || 'æ— ',
            note: 'èµ„æºè·¯å¾„éªŒè¯å·²ç§»è‡³mapç»„ä»¶'
          })
        }
      }
      
      console.log('âœ… åœ°å½¢ç”Ÿæˆå’ŒéªŒè¯å®Œæˆ')
      
    } catch (error) {
      console.error('âŒ åœ°å½¢ç”Ÿæˆå¤±è´¥:', {
        errorMessage: error.message,
        errorStack: error.stack,
        terrainGeneratorExists: !!terrainGenerator,
        terrainGeneratorType: typeof terrainGenerator
      })
      
      console.log('ğŸ”„ å›é€€åˆ°é»˜è®¤åœ°å½¢ç”Ÿæˆ')
      try {
        this.initializeDefaultTerrain()
        
        // éªŒè¯é»˜è®¤åœ°å½¢æ˜¯å¦æˆåŠŸåˆ›å»º
        if (!this.validateTerrainGrid(this.terrainGrid)) {
          console.error('âŒ é»˜è®¤åœ°å½¢åˆ›å»ºä¹Ÿå¤±è´¥äº†ï¼Œå¼ºåˆ¶åˆ›å»ºæœ€å°åœ°å½¢')
          this.terrainGrid = this.createDefaultTerrainGrid()
          this.currentBiome = 'TemperateForest'
          this.playerPosition = { x: 2, y: 2 }
        }
        
        console.log('âœ… é»˜è®¤åœ°å½¢åˆ›å»ºæˆåŠŸ')
      } catch (fallbackError) {
        console.error('âŒ é»˜è®¤åœ°å½¢åˆ›å»ºå¤±è´¥:', fallbackError.message)
        
        // æœ€åçš„å®‰å…¨ç½‘ï¼šæ‰‹åŠ¨åˆ›å»ºæœ€å°å¯ç”¨åœ°å½¢
        this.terrainGrid = this.createDefaultTerrainGrid()
        this.currentBiome = 'TemperateForest'
        this.playerPosition = { x: 2, y: 2 }
        this.currentTileInfo = { biome: 'TemperateForest', hill: null, object: null }
        
        console.log('ğŸ›¡ï¸ å¼ºåˆ¶åˆ›å»ºæœ€å°åœ°å½¢å®Œæˆ')
      }
    }
  },
  
  regenerateTerrain() {
    console.log('ğŸ”„ å¼€å§‹é‡æ–°ç”Ÿæˆåœ°å½¢...')
    
    try {
      // æ¸…é™¤é¢„ç”Ÿæˆçš„åœ°å›¾æ•°æ®ï¼Œå¼ºåˆ¶é‡æ–°ç”Ÿæˆ
      this.preGeneratedTerrain = null
      
      // é‡ç½®åœ°å½¢ç½‘æ ¼çŠ¶æ€
      this.terrainGrid = null
      
      // éªŒè¯terrainGeneratorå¯ç”¨æ€§
      if (!terrainGenerator) {
        console.error('âŒ terrainGeneratorä¸å¯ç”¨ï¼Œä½¿ç”¨é»˜è®¤åœ°å½¢')
        this.initializeDefaultTerrain()
        return
      }
      
      // é‡æ–°ç”Ÿæˆåœ°å½¢
      this.generateTerrain()
      
      // éªŒè¯ç”Ÿæˆç»“æœ
      if (!this.validateTerrainGrid(this.terrainGrid)) {
        console.error('âŒ åœ°å½¢é‡æ–°ç”Ÿæˆå¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤åœ°å½¢')
        this.initializeDefaultTerrain()
        return
      }
      
      // ç¡®ä¿ç©å®¶ä½ç½®æœ‰æ•ˆ
      this.ensurePlayerCenterPosition()
      
      // æ›´æ–°å½“å‰åœ°å—ä¿¡æ¯
      this.updateCurrentTileInfo()
      
      console.log('âœ… åœ°å½¢é‡æ–°ç”Ÿæˆå®Œæˆ:', {
        gridSize: `${this.terrainGrid[0].length}x${this.terrainGrid.length}`,
        playerPosition: this.playerPosition
      })
    } catch (error) {
      console.error('âŒ é‡æ–°ç”Ÿæˆåœ°å½¢æ—¶å‘ç”Ÿé”™è¯¯:', {
        error: error.message,
        fallbackToDefault: true
      })
      
      // å‘ç”Ÿé”™è¯¯æ—¶ä½¿ç”¨é»˜è®¤åœ°å½¢
      this.initializeDefaultTerrain()
    }
  },
  
  // è‡ªåŠ¨ç§»åŠ¨ç©å®¶ï¼ˆæŒ‚æœºæ¨¡å¼ï¼‰
  autoMovePlayer() {
    console.log('ğŸš¶ å¼€å§‹è‡ªåŠ¨ç§»åŠ¨ç©å®¶...')
    
    // éªŒè¯terrainGeneratorå¯ç”¨æ€§
    if (!terrainGenerator || !terrainGenerator.movePlayer) {
      console.error('âŒ terrainGeneratorä¸å¯ç”¨ï¼Œæ— æ³•ç§»åŠ¨ç©å®¶')
      return
    }
    
    // éªŒè¯å½“å‰ç©å®¶ä½ç½®
    if (!this.playerPosition) {
      console.error('âŒ å½“å‰ç©å®¶ä½ç½®æœªå®šä¹‰')
      return
    }
    
    try {
      const directions = ['north', 'south', 'east', 'west']
      const randomDirection = directions[Math.floor(Math.random() * directions.length)]
      
      console.log('ğŸ¯ å°è¯•ç§»åŠ¨æ–¹å‘:', randomDirection)
      
      const moved = terrainGenerator.movePlayer(randomDirection)
      if (moved) {
        const terrain = terrainGenerator.getCurrentTerrain()
        if (terrain && terrain.playerPosition) {
          this.playerPosition = { ...terrain.playerPosition }
          console.log('âœ… ç©å®¶ç§»åŠ¨æˆåŠŸ:', this.playerPosition)
          this.updateCurrentTileInfo()
        } else {
          console.error('âŒ terrainGeneratorè¿”å›æ— æ•ˆåœ°å½¢æ•°æ®')
        }
      } else {
        console.log('âš ï¸ ç©å®¶ç§»åŠ¨å¤±è´¥ï¼Œå¯èƒ½é‡åˆ°è¾¹ç•Œæˆ–éšœç¢')
      }
    } catch (error) {
      console.error('âŒ è‡ªåŠ¨ç§»åŠ¨ç©å®¶æ—¶å‘ç”Ÿé”™è¯¯:', {
        error: error.message,
        currentPosition: this.playerPosition
      })
    }
  },
  
  // æ›´æ–°å½“å‰ä½ç½®ä¿¡æ¯
  updateCurrentTileInfo() {
    console.log('ğŸ”„ å¼€å§‹æ›´æ–°å½“å‰åœ°å—ä¿¡æ¯...')
    
    // éªŒè¯ç©å®¶ä½ç½®
    if (!this.playerPosition) {
      console.error('âŒ ç©å®¶ä½ç½®æœªå®šä¹‰ï¼Œæ— æ³•æ›´æ–°åœ°å—ä¿¡æ¯')
      this.currentTileInfo = { biome: 'TemperateForest', hill: null, object: null }
      return
    }
    
    console.log('ğŸ“ å½“å‰ç©å®¶ä½ç½®:', this.playerPosition)
    
    // éªŒè¯ä½ç½®æ˜¯å¦åœ¨æœ‰æ•ˆèŒƒå›´å†…
    if (!this.isValidPosition(this.playerPosition.x, this.playerPosition.y)) {
      console.error('âŒ ç©å®¶ä½ç½®è¶…å‡ºåœ°å›¾èŒƒå›´')
      this.currentTileInfo = { biome: 'TemperateForest', hill: null, object: null }
      return
    }
    
    try {
      // ä¼˜å…ˆä»æœ¬åœ°terrainGridè·å–åœ°å—ä¿¡æ¯
      const localTile = this.getCurrentTile()
      if (localTile && localTile.biome) {
        this.currentTileInfo = { ...localTile }
        console.log('âœ… ä»æœ¬åœ°terrainGridè·å–åœ°å—ä¿¡æ¯æˆåŠŸ:', this.currentTileInfo)
      } else {
        // å¤‡ç”¨ï¼šä»terrainGeneratorè·å–
        if (terrainGenerator && terrainGenerator.getCurrentTileInfo) {
          const tileInfo = terrainGenerator.getCurrentTileInfo()
          if (tileInfo && tileInfo.biome) {
            this.currentTileInfo = tileInfo
            console.log('âœ… ä»terrainGeneratorè·å–åœ°å—ä¿¡æ¯æˆåŠŸ:', this.currentTileInfo)
          } else {
            throw new Error('terrainGeneratorè¿”å›æ— æ•ˆåœ°å—ä¿¡æ¯')
          }
        } else {
          throw new Error('terrainGeneratorä¸å¯ç”¨')
        }
      }
      
      // éªŒè¯åœ°å—ä¿¡æ¯çš„æœ‰æ•ˆæ€§
      if (this.currentTileInfo.biome) {
        console.log('ğŸŒ² å½“å‰åœ°å—ç”Ÿç‰©ç¾¤ç³»éªŒè¯:', {
          biome: this.currentTileInfo.biome,
          note: 'è·¯å¾„éªŒè¯å·²ç§»è‡³mapç»„ä»¶'
        })
      }
      
    } catch (error) {
      console.error('âŒ æ›´æ–°åœ°å—ä¿¡æ¯æ—¶å‘ç”Ÿé”™è¯¯:', {
        errorMessage: error.message,
        playerPosition: this.playerPosition,
        terrainGridValid: this.validateTerrainGrid(this.terrainGrid)
      })
      
      // ä½¿ç”¨é»˜è®¤åœ°å—ä¿¡æ¯
      this.currentTileInfo = {
        biome: this.currentBiome || 'TemperateForest',
        hill: null,
        object: null
      }
      console.log('ğŸ”„ ä½¿ç”¨é»˜è®¤åœ°å—ä¿¡æ¯:', this.currentTileInfo)
    }
    
    console.log('âœ… å½“å‰åœ°å—ä¿¡æ¯æ›´æ–°å®Œæˆ')
  },
  
  // ç‚¹å‡»åœ°å½¢å—
  onTileClick(x, y) {
    console.log('ğŸ–±ï¸ åœ°å—ç‚¹å‡»äº‹ä»¶:', { x, y })
    
    // éªŒè¯åæ ‡æœ‰æ•ˆæ€§
    if (typeof x !== 'number' || typeof y !== 'number' || isNaN(x) || isNaN(y)) {
      console.error('âŒ æ— æ•ˆçš„åœ°å—åæ ‡:', { x, y })
      return
    }
    
    // éªŒè¯terrainGridæœ‰æ•ˆæ€§
    if (!this.validateTerrainGrid(this.terrainGrid)) {
      console.error('âŒ terrainGridæ— æ•ˆï¼Œæ— æ³•å¤„ç†åœ°å—ç‚¹å‡»')
      return
    }
    
    // æ£€æŸ¥ç‚¹å‡»ä½ç½®æ˜¯å¦åœ¨æœ‰æ•ˆèŒƒå›´å†…
    if (!this.isValidPosition(x, y)) {
      console.error('âŒ ç‚¹å‡»ä½ç½®è¶…å‡ºåœ°å›¾èŒƒå›´:', { x, y, mapSize: `${this.terrainGrid[0].length}x${this.terrainGrid.length}` })
      return
    }
    
    try {
      // æ›´æ–°ç©å®¶ä½ç½®
      this.playerPosition = { x: x, y: y }
      
      // åŒæ­¥åˆ°terrainGenerator
      if (terrainGenerator && terrainGenerator.setPlayerPosition) {
        terrainGenerator.setPlayerPosition(x, y)
        console.log('âœ… ç©å®¶ä½ç½®å·²åŒæ­¥åˆ°terrainGenerator')
      } else {
        console.warn('âš ï¸ terrainGeneratorä¸å¯ç”¨ï¼Œæ— æ³•åŒæ­¥ç©å®¶ä½ç½®')
      }
      
      // æ›´æ–°å½“å‰åœ°å—ä¿¡æ¯
      this.updateCurrentTileInfo()
      
      console.log('âœ… ç©å®¶ä½ç½®å·²æ›´æ–°:', this.playerPosition)
    } catch (error) {
      console.error('âŒ å¤„ç†åœ°å—ç‚¹å‡»æ—¶å‘ç”Ÿé”™è¯¯:', {
        error: error.message,
        position: { x, y },
        playerPosition: this.playerPosition
      })
    }
  },
  
  // åˆ¤æ–­æ˜¯å¦ä¸ºç©å®¶ä½ç½®
  isPlayerPosition(x, y) {
    const isPlayer = this.playerPosition.x === x && this.playerPosition.y === y
    if (isPlayer) {
      console.log(`ğŸ¯ ç©å®¶ä½ç½®åŒ¹é…: (${x},${y}) === (${this.playerPosition.x},${this.playerPosition.y})`)
      console.log('ğŸ‘¤ äººç‰©æ¨¡å‹è·¯å¾„çŠ¶æ€:', this.characterPaths)
    }
    return isPlayer
  },
  
  // è·å–åœ°å½¢å—æ ·å¼
  getTileStyle(x, y) {
    const isPlayer = this.isPlayerPosition(x, y)
    return {
      backgroundColor: isPlayer ? 'rgba(255, 0, 0, 0.2)' : 'transparent'
    }
  },
  


  // è·å–å½“å‰ä½ç½®çš„åœ°å½¢ä¿¡æ¯
  getCurrentTile() {
    if (!this.playerPosition) {
      console.error('âŒ ç©å®¶ä½ç½®æœªå®šä¹‰')
      return { biome: 'TemperateForest', hill: null, object: null }
    }
    
    const tile = this.getTileAt(this.playerPosition.x, this.playerPosition.y)
    if (tile) {
      return tile
    }
    
    console.error('âŒ æ— æ³•è·å–å½“å‰ä½ç½®çš„åœ°å—ä¿¡æ¯ï¼Œä½¿ç”¨é»˜è®¤å€¼')
    return { biome: 'TemperateForest', hill: null, object: null }
  },



  getCurrentTileInfo() {
    const tile = this.getCurrentTile()
    const { x, y } = this.playerPosition || { x: 0, y: 0 }
    let info = `ä½ç½®(${x},${y}) - ${tile.biome}`
    if (tile.hill) info += ` - ${tile.hill}`
    if (tile.object) info += ` - ${tile.object}`
    return info
  },
  
  // ç¡®ä¿ç©å®¶ä½ç½®åœ¨åœ°å›¾ä¸­å¤®
  ensurePlayerCenterPosition() {
    if (!this.validateTerrainGrid(this.terrainGrid)) {
      console.error('âŒ terrainGridæ— æ•ˆï¼Œæ— æ³•è®¾ç½®ç©å®¶ä½ç½®')
      this.playerPosition = { x: 2, y: 2 } // é»˜è®¤ä½ç½®
      return
    }
    
    const centerX = Math.floor(this.terrainGrid[0].length / 2)
    const centerY = Math.floor(this.terrainGrid.length / 2)
    this.playerPosition = { x: centerX, y: centerY }
    
    console.log('ğŸ‘¤ ç©å®¶ä½ç½®å·²è®¾ç½®åˆ°åœ°å›¾ä¸­å¤®:', {
      position: this.playerPosition,
      gridSize: `${this.terrainGrid.length}x${this.terrainGrid[0].length}`,
      isValidPosition: this.isValidPosition(this.playerPosition.x, this.playerPosition.y)
    })
    
    // åŒæ­¥æ›´æ–°terrainGeneratorä¸­çš„ç©å®¶ä½ç½®
    if (terrainGenerator && terrainGenerator.currentTerrain) {
      terrainGenerator.currentTerrain.playerPosition = { ...this.playerPosition }
      console.log('âœ… ç©å®¶ä½ç½®å·²åŒæ­¥åˆ°terrainGenerator')
    }
  },
  
  // éªŒè¯ä½ç½®æ˜¯å¦æœ‰æ•ˆ
  isValidPosition(x, y) {
    if (!this.validateTerrainGrid(this.terrainGrid)) {
      return false
    }
    
    return x >= 0 && x < this.terrainGrid[0].length && y >= 0 && y < this.terrainGrid.length
  },
  
  // åˆå§‹åŒ–èµ„æº
  initializeResources() {
    if (this.story && this.story.startingResources) {
      this.resources = { ...this.story.startingResources }
    } else {
      // é»˜è®¤èµ„æº
      this.resources = {
        food: 75,
        medicine: 30,
        steel: 450,
        wood: 300,
        silver: 800,
        components: 25,
        gold: 0
      }
    }
    console.log('åˆå§‹åŒ–èµ„æº:', this.resources)
  },
  
  // åˆå§‹åŒ–æ¸¸æˆè®¾ç½®
  initializeGameSettings() {
    if (this.gameSettings) {
      this.isPaused = this.gameSettings.pauseOnLoad || false
      this.gameSpeed = 1
    }
  },
  
  // åˆ›å»ºåˆå§‹å­˜æ¡£
  createInitialSave() {
    console.log('ğŸ’¾ å¼€å§‹åˆ›å»ºåˆå§‹å­˜æ¡£...')
    
    try {
      const gameData = this.getGameData()
      const colonistName = this.colonistData?.name || this.currentCharacter?.name || 'æœªçŸ¥'
      const saveName = `åˆå§‹å­˜æ¡£_${colonistName}_${new Date().toLocaleString()}`
      
      console.log('ğŸ“Š æ¸¸æˆæ•°æ®å‡†å¤‡å®Œæˆ:', {
        gameId: gameData.gameId,
        colonistName: colonistName,
        currentDay: gameData.currentDay,
        currentSeason: gameData.currentSeason,
        resourcesCount: Object.keys(gameData.resources || {}).length,
        hasCharacter: !!gameData.currentCharacter,
        hasSettings: !!gameData.gameSettings
      })
      
      saveManager.saveGame(saveName, gameData).then(() => {
        console.log('âœ… åˆå§‹å­˜æ¡£åˆ›å»ºæˆåŠŸ:', saveName)
        console.log('ğŸ’¾ å­˜æ¡£æ•°æ®å¤§å°:', JSON.stringify(gameData).length, 'å­—ç¬¦')
      }).catch(error => {
        console.log('âŒ åˆå§‹å­˜æ¡£åˆ›å»ºå¤±è´¥:', error.message)
        console.log('ğŸ” å¤±è´¥çš„æ¸¸æˆæ•°æ®:', gameData)
      })
    } catch (error) {
      console.log('âŒ åˆ›å»ºåˆå§‹å­˜æ¡£æ—¶å‘ç”Ÿå¼‚å¸¸:', error.message)
    }
  },
  
  // äººç‰©æ¨¡å‹ç›¸å…³æ–¹æ³•
  initializeCharacter(colonistData) {
    // ä½¿ç”¨ä¼ å…¥çš„è§’è‰²æ•°æ®
    if (colonistData && colonistData.characterPaths) {
      this.characterPaths = { ...colonistData.characterPaths }
      this.currentCharacter = colonistData
      // æ›´æ–°characterModelæ•°æ®
      this.characterModel = {
        bodyPath: this.characterPaths.body || '',
        headPath: this.characterPaths.head || '',
        hairPath: this.characterPaths.hair || '',
        beardPath: this.characterPaths.beard || ''
      }
      console.log('âœ… ä½¿ç”¨ä¼ å…¥çš„è§’è‰²æ•°æ®å’Œè·¯å¾„')
    } else if (colonistData) {
      // å¦‚æœæœ‰è§’è‰²æ•°æ®ä½†æ²¡æœ‰è·¯å¾„ï¼Œé‡æ–°ç”Ÿæˆè·¯å¾„
      this.currentCharacter = colonistData
      this.generateCharacterPaths()
      console.log('âœ… ä½¿ç”¨ä¼ å…¥çš„è§’è‰²æ•°æ®ï¼Œé‡æ–°ç”Ÿæˆè·¯å¾„')
    } else {
      // ç”Ÿæˆé»˜è®¤è§’è‰²
      this.currentCharacter = humanDisplay.generateRandomHumanConfig()
      this.updateCharacterPaths()
      console.log('âš ï¸ ä½¿ç”¨é»˜è®¤è§’è‰²æ•°æ®')
    }
    
    // è¯¦ç»†æ—¥å¿—ï¼šæ‰“å°äººç‰©æ¨¡å‹èµ„æºè·¯å¾„
    console.log('ğŸ§‘ åˆå§‹åŒ–è§’è‰²å®Œæˆ:', {
      name: this.currentCharacter?.name,
      gender: this.currentCharacter?.gender,
      bodyType: this.currentCharacter?.bodyType,
      hair: this.currentCharacter?.hair
    })
    
    console.log('ğŸ‘¤ äººç‰©æ¨¡å‹èµ„æºè·¯å¾„æ£€æŸ¥:')
    if (this.characterPaths) {
      console.log('ğŸ­ èº«ä½“è·¯å¾„:', this.characterPaths.body || 'æ— ')
      console.log('ğŸ‘¤ å¤´éƒ¨è·¯å¾„:', this.characterPaths.head || 'æ— ')
      console.log('ğŸ’‡ å¤´å‘è·¯å¾„:', this.characterPaths.hair || 'æ— ')
      console.log('ğŸ§” èƒ¡é¡»è·¯å¾„:', this.characterPaths.beard || 'æ— ')
    } else {
      console.log('âŒ äººç‰©æ¨¡å‹è·¯å¾„æœªè®¾ç½®')
    }
  },
  
  // ç”Ÿæˆè§’è‰²è·¯å¾„
  generateCharacterPaths() {
    if (!this.currentCharacter) return
    
    const character = this.currentCharacter
    this.characterPaths = {
      body: `/common/human/bodies/${character.bodyType || 'Naked_Male'}_south.png`,
      head: character.gender === 'female' 
        ? '/common/human/heads/Female/Female_Average_Normal_south.png'
        : '/common/human/heads/Male/Male_Average_Normal_south.png',
      hair: character.hair && character.hair !== 'Shaved' 
        ? `/common/human/haris/${character.hair}_south.png` 
        : '',
      beard: character.beard 
        ? `/common/human/beards/${character.beard}_south.png` 
        : ''
    }
    
    // åŒæ—¶æ›´æ–°characterModelæ•°æ®ä¾›æ¨¡æ¿ä½¿ç”¨
    this.characterModel = {
      bodyPath: this.characterPaths.body || '',
      headPath: this.characterPaths.head || '',
      hairPath: this.characterPaths.hair || '',
      beardPath: this.characterPaths.beard || ''
    }
    
    console.log('ğŸ”§ ç”Ÿæˆçš„è§’è‰²è·¯å¾„:', this.characterPaths)
    console.log('ğŸ­ ç”Ÿæˆçš„äººç‰©æ¨¡å‹æ•°æ®:', this.characterModel)
  },
  
  updateCharacterPaths() {
    // æ›´æ–°äººç‰©å„éƒ¨ä»¶çš„å›¾ç‰‡è·¯å¾„
    if (this.currentCharacter) {
      this.characterPaths = humanDisplay.getHumanPartsPaths(this.currentCharacter, this.currentDirection)
      
      // åŒæ—¶æ›´æ–°characterModelæ•°æ®ä¾›æ¨¡æ¿ä½¿ç”¨
      this.characterModel = {
        bodyPath: this.characterPaths.body || '',
        headPath: this.characterPaths.head || '',
        hairPath: this.characterPaths.hair || '',
        beardPath: this.characterPaths.beard || ''
      }
      
      console.log('ğŸ­ æ›´æ–°äººç‰©æ¨¡å‹æ•°æ®:', this.characterModel)
    }
  },
  
  // ä¿å­˜æ¸¸æˆ
  saveGame() {
    const gameData = this.getGameData()
    const saveName = `åœ°å½¢æ¢ç´¢_${new Date().toLocaleString()}`
    
    saveManager.saveGame(saveName, gameData).then(() => {
      console.log('æ¸¸æˆä¿å­˜æˆåŠŸ')
    }).catch(error => {
      console.error(`ä¿å­˜å¤±è´¥: ${error.message}`)
    })
  },
  
  // åŠ è½½æ¸¸æˆ
  loadGame() {
    saveManager.getSaveList().then(saveList => {
      if (saveList.length === 0) {
        console.log('æ²¡æœ‰å¯åŠ è½½çš„å­˜æ¡£')
        return
      }
      
      const latestSave = saveList[0]
      return saveManager.loadGame(latestSave.name)
    }).then(saveData => {
      if (saveData) {
        this.loadGameData(saveData.data)
        console.log(`å­˜æ¡£åŠ è½½æˆåŠŸ: ${saveData.name}`)
      }
    }).catch(error => {
      console.error(`åŠ è½½å¤±è´¥: ${error.message}`)
    })
  },
  
  // è·å–æ¸¸æˆæ•°æ®
  getGameData() {
    // ç”Ÿæˆåœ°å½¢ç½‘æ ¼çš„å­˜æ¡£æ ¼å¼ï¼ˆ[x,y] - Biomeæ ¼å¼ï¼‰
    const terrainGridForSave = []
    if (this.terrainGrid && this.terrainGrid.length > 0) {
      for (let y = 0; y < this.terrainGrid.length; y++) {
        terrainGridForSave[y] = []
        for (let x = 0; x < this.terrainGrid[y].length; x++) {
          const tile = this.terrainGrid[y][x]
          terrainGridForSave[y][x] = `[${x},${y}] - ${tile.biome}${tile.hill ? ` (${tile.hill})` : ''}${tile.object ? ` [${tile.object}]` : ''}`
        }
      }
    }
    
    return {
      // åŸºç¡€æ¸¸æˆä¿¡æ¯
      gameId: this.gameId,
      gameStartTime: this.gameStartTime,
      currentDay: this.currentDay,
      currentSeason: this.currentSeason,
      currentYear: this.currentYear,
      gameTime: this.gameTime,
      
      // æ¸¸æˆçŠ¶æ€
      isPaused: this.isPaused,
      gameSpeed: this.gameSpeed,
      
      // é…ç½®æ•°æ®
      colonist: this.colonistData || this.colonist,
      narrator: this.narrator,
      story: this.story,
      gameSettings: this.gameSettings,
      
      // èµ„æºå’Œæ®–æ°‘åœ°çŠ¶æ€
      resources: { ...this.resources },
      colonyMood: this.colonyMood,
      colonyWealth: this.colonyWealth,
      threatLevel: this.threatLevel,
      
      // åœ°å½¢å’Œä½ç½®ï¼ˆä¿å­˜åŸå§‹åœ°å½¢æ•°æ®å’Œæ ¼å¼åŒ–çš„å­˜æ¡£æ•°æ®ï¼‰
      terrainGrid: this.terrainGrid, // åŸå§‹åœ°å½¢æ•°æ®ï¼Œç”¨äºæ¸¸æˆé€»è¾‘
      terrainGridFormatted: terrainGridForSave, // æ ¼å¼åŒ–çš„å­˜æ¡£æ•°æ®ï¼Œç”¨äºæ˜¾ç¤º
      currentBiome: this.currentBiome,
      playerPosition: { ...this.playerPosition },
      currentTileInfo: { ...this.currentTileInfo },
      
      // è§’è‰²ä¿¡æ¯
      currentCharacter: this.currentCharacter,
      currentDirection: this.currentDirection,
      characterPaths: { ...this.characterPaths },
      
      // å­˜æ¡£å…ƒæ•°æ®
      saveVersion: '1.0.0',
      lastSaved: Date.now()
    }
  },
  
  // åŠ è½½æ¸¸æˆæ•°æ®
  loadGameData(gameData) {
    console.log('ğŸ“‚ å¼€å§‹åŠ è½½æ¸¸æˆæ•°æ®...')
    
    if (!gameData) {
      console.log('âŒ åŠ è½½å¤±è´¥: æ¸¸æˆæ•°æ®ä¸ºç©º')
      return
    }
    
    console.log('ğŸ“Š æ¥æ”¶åˆ°çš„å­˜æ¡£æ•°æ®:', {
      gameId: gameData.gameId,
      hasCharacter: !!gameData.currentCharacter,
      hasResources: !!gameData.resources,
      hasSettings: !!gameData.gameSettings,
      hasTerrain: !!gameData.terrainGrid,
      saveVersion: gameData.saveVersion,
      lastSaved: gameData.lastSaved ? new Date(gameData.lastSaved).toLocaleString() : 'æœªçŸ¥'
    })
    
    try {
      // åŸºç¡€æ¸¸æˆä¿¡æ¯
      this.gameId = gameData.gameId || this.gameId
      this.gameStartTime = gameData.gameStartTime || this.gameStartTime
      this.currentDay = gameData.currentDay || 1
      this.currentSeason = gameData.currentSeason || 'spring'
      this.currentYear = gameData.currentYear || 5500
      this.gameTime = gameData.gameTime || 0
      console.log('âœ… åŸºç¡€æ¸¸æˆä¿¡æ¯åŠ è½½å®Œæˆ')
      
      // æ¸¸æˆçŠ¶æ€
      this.isPaused = gameData.isPaused || false
      this.gameSpeed = gameData.gameSpeed || 1
      
      // é…ç½®æ•°æ®
      this.colonist = gameData.colonist || this.colonist
      this.narrator = gameData.narrator || this.narrator
      this.story = gameData.story || this.story
      this.gameSettings = gameData.gameSettings || this.gameSettings
      console.log('âœ… æ¸¸æˆè®¾ç½®åŠ è½½å®Œæˆ')
      
      // èµ„æºå’Œæ®–æ°‘åœ°çŠ¶æ€
      if (gameData.resources) {
        this.resources = { ...gameData.resources }
        console.log('âœ… èµ„æºæ•°æ®åŠ è½½å®Œæˆ:', this.resources)
      }
      this.colonyMood = gameData.colonyMood || 50
      this.colonyWealth = gameData.colonyWealth || 0
      this.threatLevel = gameData.threatLevel || 0
      console.log('âœ… æ®–æ°‘åœ°çŠ¶æ€åŠ è½½å®Œæˆ')
      
      // åœ°å½¢å’Œä½ç½®
      console.log('ğŸ—ºï¸ å¼€å§‹åŠ è½½åœ°å½¢å’Œä½ç½®æ•°æ®...')
      console.log('ğŸ“Š å­˜æ¡£ä¸­çš„åœ°å½¢æ•°æ®:', {
        hasTerrainGrid: !!gameData.terrainGrid,
        terrainGridType: typeof gameData.terrainGrid,
        isTerrainArray: Array.isArray(gameData.terrainGrid),
        terrainGridLength: gameData.terrainGrid ? gameData.terrainGrid.length : 0,
        firstRowLength: gameData.terrainGrid && gameData.terrainGrid[0] ? gameData.terrainGrid[0].length : 0,
        currentBiome: gameData.currentBiome,
        playerPosition: gameData.playerPosition,
        currentTileInfo: gameData.currentTileInfo
      })
      
      this.terrainGrid = gameData.terrainGrid || []
      this.currentBiome = gameData.currentBiome || 'TemperateForest'
      this.playerPosition = gameData.playerPosition || { x: 2, y: 2 }
      this.currentTileInfo = gameData.currentTileInfo || { biome: 'TemperateForest', hill: null, object: null }
      
      console.log('ğŸ—ºï¸ åœ°å½¢æ•°æ®åº”ç”¨å®Œæˆ:', {
        terrainGridSize: this.terrainGrid.length > 0 ? `${this.terrainGrid.length}x${this.terrainGrid[0].length}` : 'ç©º',
        currentBiome: this.currentBiome,
        playerPosition: this.playerPosition,
        currentTileInfo: this.currentTileInfo
      })
      
      // éªŒè¯åœ°å½¢æ•°æ®å®Œæ•´æ€§
      if (this.terrainGrid && this.terrainGrid.length > 0) {
        console.log('ğŸ” éªŒè¯åœ°å½¢æ•°æ®å®Œæ•´æ€§...')
        let isValidTerrain = true
        let terrainErrors = []
        
        // æ£€æŸ¥ç½‘æ ¼ç»“æ„
        if (!Array.isArray(this.terrainGrid)) {
          isValidTerrain = false
          terrainErrors.push('åœ°å½¢ç½‘æ ¼ä¸æ˜¯æ•°ç»„')
        } else {
          const expectedCols = this.terrainGrid[0] ? this.terrainGrid[0].length : 0
          for (let y = 0; y < this.terrainGrid.length; y++) {
            if (!Array.isArray(this.terrainGrid[y])) {
              isValidTerrain = false
              terrainErrors.push(`ç¬¬${y}è¡Œä¸æ˜¯æ•°ç»„`)
              break
            }
            if (this.terrainGrid[y].length !== expectedCols) {
              isValidTerrain = false
              terrainErrors.push(`ç¬¬${y}è¡Œåˆ—æ•°ä¸ä¸€è‡´`)
            }
          }
        }
        
        // æ£€æŸ¥ç©å®¶ä½ç½®
        if (this.terrainGrid.length > 0) {
          const maxX = this.terrainGrid[0].length - 1
          const maxY = this.terrainGrid.length - 1
          if (this.playerPosition.x < 0 || this.playerPosition.x > maxX || 
              this.playerPosition.y < 0 || this.playerPosition.y > maxY) {
            console.log('âš ï¸ ç©å®¶ä½ç½®è¶…å‡ºåœ°å›¾èŒƒå›´ï¼Œé‡ç½®åˆ°å®‰å…¨ä½ç½®')
            this.playerPosition = {
              x: Math.floor(this.terrainGrid[0].length / 2),
              y: Math.floor(this.terrainGrid.length / 2)
            }
            console.log('ğŸ”„ ç©å®¶ä½ç½®å·²é‡ç½®ä¸º:', this.playerPosition)
          }
        }
        
        if (!isValidTerrain) {
          console.log('âŒ åœ°å½¢æ•°æ®éªŒè¯å¤±è´¥:', terrainErrors)
        } else {
          console.log('âœ… åœ°å½¢æ•°æ®éªŒè¯é€šè¿‡')
        }
      }
      
      // åŒæ­¥æ›´æ–°terrainGeneratorä¸­çš„åœ°å½¢æ•°æ®
      if (this.terrainGrid && this.terrainGrid.length > 0) {
        console.log('ğŸ”„ å¼€å§‹åŒæ­¥åœ°å½¢æ•°æ®åˆ°terrainGenerator...')
        console.log('ğŸ” terrainGeneratorçŠ¶æ€æ£€æŸ¥:', {
          terrainGeneratorExists: !!terrainGenerator,
          terrainGeneratorType: typeof terrainGenerator,
          hasCurrentTerrain: !!terrainGenerator.currentTerrain
        })
        
        terrainGenerator.currentTerrain = {
          grid: this.terrainGrid,
          biome: this.currentBiome,
          playerPosition: this.playerPosition
        }
        console.log('âœ… åœ°å½¢æ•°æ®å·²åŒæ­¥åˆ°terrainGenerator')
        
        // éªŒè¯åŒæ­¥ç»“æœ
        if (terrainGenerator.currentTerrain) {
          console.log('ğŸ” åŒæ­¥åçš„terrainGenerator.currentTerrain:', {
            hasGrid: !!terrainGenerator.currentTerrain.grid,
            gridSize: terrainGenerator.currentTerrain.grid ? 
              `${terrainGenerator.currentTerrain.grid.length}x${terrainGenerator.currentTerrain.grid[0].length}` : 'æ— ',
            biome: terrainGenerator.currentTerrain.biome,
            playerPosition: terrainGenerator.currentTerrain.playerPosition
          })
        }
      } else {
        console.log('âš ï¸ æ— æœ‰æ•ˆåœ°å½¢æ•°æ®ï¼Œè·³è¿‡terrainGeneratoråŒæ­¥')
      }
      
      console.log('âœ… åœ°å½¢å’Œä½ç½®ä¿¡æ¯åŠ è½½å®Œæˆ')
      
      // è§’è‰²ä¿¡æ¯
      this.currentCharacter = gameData.currentCharacter || null
      this.currentDirection = gameData.currentDirection || 'south'
      this.characterPaths = gameData.characterPaths || this.characterPaths
      if (this.currentCharacter) {
        console.log('âœ… è§’è‰²æ•°æ®åŠ è½½å®Œæˆ:', this.currentCharacter.name)
      }
      
      // é‡æ–°è®¾ç½®åœ°å½¢ç”Ÿæˆå™¨çŠ¶æ€
      if (this.terrainGrid.length > 0) {
        terrainGenerator.currentTerrain = {
          grid: this.terrainGrid,
          playerPosition: this.playerPosition,
          biome: this.currentBiome
        }
        console.log('âœ… åœ°å½¢ç”Ÿæˆå™¨çŠ¶æ€æ¢å¤å®Œæˆ')
      }
      
      // æ›´æ–°å½“å‰ä½ç½®ä¿¡æ¯
      this.updateCurrentTileInfo()
      
      console.log('ğŸ‰ æ¸¸æˆæ•°æ®åŠ è½½å…¨éƒ¨å®Œæˆï¼')
    } catch (error) {
      console.log('âŒ åŠ è½½æ¸¸æˆæ•°æ®æ—¶å‘ç”Ÿé”™è¯¯:', error.message)
      console.log('ğŸ” é”™è¯¯çš„æ•°æ®:', gameData)
    }
  },
  
  // å¯åŠ¨è‡ªåŠ¨å­˜æ¡£
  startAutoSave() {
    saveManager.loadSettings().then(settings => {
      if (settings.autoSave) {
        this.autoSaveTimer = setInterval(() => {
          const gameData = this.getGameData()
          saveManager.saveGame('è‡ªåŠ¨å­˜æ¡£', gameData, true).then(() => {
            console.log('è‡ªåŠ¨å­˜æ¡£å®Œæˆ')
          }).catch(error => {
            console.error('è‡ªåŠ¨å­˜æ¡£å¤±è´¥:', error)
          })
        }, settings.autoSaveInterval || 300000) // é»˜è®¤5åˆ†é’Ÿ
      }
    })
  },
  
  // å¯åŠ¨è‡ªåŠ¨ç§»åŠ¨
  startAutoMovement() {
    if (this.autoMoveTimer) {
      clearInterval(this.autoMoveTimer)
      this.autoMoveTimer = null
    }
    this.autoMoveTimer = setInterval(() => {
      this.autoMovePlayer()
    }, 3000) // æ¯3ç§’è‡ªåŠ¨ç§»åŠ¨ä¸€æ¬¡
    console.log('ğŸš€ è‡ªåŠ¨ç§»åŠ¨å®šæ—¶å™¨å·²å¯åŠ¨')
  },

  // åœæ­¢è‡ªåŠ¨ç§»åŠ¨
  stopAutoMovement() {
    if (this.autoMoveTimer) {
      clearInterval(this.autoMoveTimer)
      this.autoMoveTimer = null
      console.log('â¹ï¸ è‡ªåŠ¨ç§»åŠ¨å®šæ—¶å™¨å·²åœæ­¢')
    }
  },

  // åˆ‡æ¢è‡ªåŠ¨ç§»åŠ¨çŠ¶æ€
  toggleAutoMovement() {
    this.autoMoveEnabled = !this.autoMoveEnabled
    if (this.autoMoveEnabled) {
      this.startAutoMovement()
      console.log('âœ… è‡ªåŠ¨ç§»åŠ¨å·²å¼€å¯')
    } else {
      this.stopAutoMovement()
      console.log('âŒ è‡ªåŠ¨ç§»åŠ¨å·²å…³é—­')
    }
    return this.autoMoveEnabled
  },
  
  // è¾…åŠ©æ˜¾ç¤ºæ–¹æ³•
  getTraitsText() {
    const character = this.colonistData || this.currentCharacter
    if (!character || !character.traits) return ''
    return character.traits.map(trait => trait.name).join(', ')
  },
  
  getDifficultyText(difficulty) {
    const difficultyMap = {
      'easy': 'ç®€å•',
      'normal': 'æ™®é€š',
      'balanced': 'å¹³è¡¡',
      'hard': 'å›°éš¾',
      'extreme': 'æéš¾',
      'chaotic': 'æ··ä¹±'
    }
    return difficultyMap[difficulty] || difficulty
  },
  
  // æ‰‹åŠ¨ä¿å­˜æ¸¸æˆï¼ˆå¸¦ç”¨æˆ·è¾“å…¥å­˜æ¡£åï¼‰
  saveGameWithName() {
    // è¿™é‡Œå¯ä»¥æ·»åŠ ç”¨æˆ·è¾“å…¥å­˜æ¡£åçš„é€»è¾‘
    // æš‚æ—¶ä½¿ç”¨æ—¶é—´æˆ³ä½œä¸ºå­˜æ¡£å
    const gameData = this.getGameData()
    const saveName = `æ‰‹åŠ¨å­˜æ¡£_${this.colonist?.name || 'æœªçŸ¥'}_${new Date().toLocaleString()}`
    
    saveManager.saveGame(saveName, gameData).then(() => {
      console.log('æ‰‹åŠ¨å­˜æ¡£æˆåŠŸ:', saveName)
      // å¯ä»¥æ·»åŠ æˆåŠŸæç¤º
    }).catch(error => {
      console.error(`æ‰‹åŠ¨å­˜æ¡£å¤±è´¥: ${error.message}`)
      // å¯ä»¥æ·»åŠ é”™è¯¯æç¤º
    })
  },
  
  // å¿«é€Ÿä¿å­˜ï¼ˆè¦†ç›–æœ€è¿‘çš„å­˜æ¡£ï¼‰
  quickSave() {
    const gameData = this.getGameData()
    const saveName = `å¿«é€Ÿå­˜æ¡£_${this.colonist?.name || 'æœªçŸ¥'}`
    
    saveManager.saveGame(saveName, gameData).then(() => {
      console.log('å¿«é€Ÿå­˜æ¡£æˆåŠŸ')
    }).catch(error => {
      console.error('å¿«é€Ÿå­˜æ¡£å¤±è´¥:', error)
    })
  },
  
  // å¿«é€ŸåŠ è½½ï¼ˆåŠ è½½æœ€è¿‘çš„å­˜æ¡£ï¼‰
  quickLoad() {
    saveManager.getSaveList().then(saveList => {
      if (saveList.length === 0) {
        console.log('æ²¡æœ‰å¯åŠ è½½çš„å­˜æ¡£')
        return
      }
      
      // æŸ¥æ‰¾æœ€è¿‘çš„éè‡ªåŠ¨å­˜æ¡£
      const manualSaves = saveList.filter(save => !save.name.includes('è‡ªåŠ¨å­˜æ¡£'))
      const latestSave = manualSaves.length > 0 ? manualSaves[0] : saveList[0]
      
      return saveManager.loadGame(latestSave.name)
    }).then(saveData => {
      if (saveData) {
        this.loadGameData(saveData.data)
        console.log(`å¿«é€ŸåŠ è½½æˆåŠŸ: ${saveData.name}`)
      }
    }).catch(error => {
      console.error(`å¿«é€ŸåŠ è½½å¤±è´¥: ${error.message}`)
    })
  },
  
  // æ¸¸æˆæ—¶é—´æ¨è¿›
  advanceTime() {
    this.gameTime += 1
    if (this.gameTime >= 24) {
      this.gameTime = 0
      this.currentDay += 1
      
      // æ¯15å¤©æ¢å­£
      if (this.currentDay % 15 === 0) {
        this.advanceSeason()
      }
    }
  },
  
  // å­£èŠ‚æ¨è¿›
  advanceSeason() {
    const seasons = ['spring', 'summer', 'autumn', 'winter']
    const currentIndex = seasons.indexOf(this.currentSeason)
    const nextIndex = (currentIndex + 1) % seasons.length
    
    this.currentSeason = seasons[nextIndex]
    
    // å¦‚æœå›åˆ°æ˜¥å¤©ï¼Œå¹´ä»½+1
    if (this.currentSeason === 'spring') {
      this.currentYear += 1
    }
  },
  
  goBack() {
    // åœ¨è¿”å›å‰ä¿å­˜å½“å‰æ¸¸æˆçŠ¶æ€
    this.quickSave()
    router.back()
  },
  

  
  // å¯åŠ¨è°ƒè¯•ä¿¡æ¯å®šæ—¶å™¨
  startDebugInfoTimer() {
    this.showDebugInfo = true
    this.debugTimer = setTimeout(() => {
      this.showDebugInfo = false
      this.debugTimer = null
      console.log('ğŸ” è°ƒè¯•ä¿¡æ¯å·²è‡ªåŠ¨éšè—')
    }, 10000) // 10ç§’åéšè—
  },
  
  // éªŒè¯åœ°å›¾æ¸²æŸ“
  validateMapRendering() {
    console.log('ğŸ—ºï¸ åœ°å›¾æ¸²æŸ“éªŒè¯å¼€å§‹...')
    
    // æ£€æŸ¥terrainGridæ•°æ®ç»“æ„
    if (!this.terrainGrid || !Array.isArray(this.terrainGrid)) {
      console.error('âŒ terrainGridæ•°æ®æ— æ•ˆ:', this.terrainGrid)
      return
    }
    
    console.log('ğŸ“Š terrainGridåŸºæœ¬ä¿¡æ¯:', {
      ç±»å‹: typeof this.terrainGrid,
      æ˜¯å¦æ•°ç»„: Array.isArray(this.terrainGrid),
      è¡Œæ•°: this.terrainGrid.length,
      åˆ—æ•°: this.terrainGrid[0]?.length || 0
    })
    
    // æ£€æŸ¥æ¯ä¸ªåœ°å—çš„æ•°æ®å’Œå›¾ç‰‡è·¯å¾„
    let validTiles = 0
    let invalidTiles = 0
    const samplePaths = []
    
    for (let rowIndex = 0; rowIndex < this.terrainGrid.length; rowIndex++) {
      const row = this.terrainGrid[rowIndex]
      if (!Array.isArray(row)) {
        console.error(`âŒ ç¬¬${rowIndex}è¡Œæ•°æ®æ— æ•ˆ:`, row)
        invalidTiles++
        continue
      }
      
      for (let colIndex = 0; colIndex < row.length; colIndex++) {
        const tile = row[colIndex]
        if (!tile || typeof tile !== 'object') {
          console.error(`âŒ åœ°å—(${rowIndex},${colIndex})æ•°æ®æ— æ•ˆ:`, tile)
          invalidTiles++
          continue
        }
        
        // éªŒè¯åœ°å—æ•°æ®ç»“æ„
        const hasValidBiome = tile.biome && typeof tile.biome === 'string'
        if (!hasValidBiome) {
          console.error(`âŒ åœ°å—(${rowIndex},${colIndex})ç¼ºå°‘æœ‰æ•ˆbiome:`, tile)
          invalidTiles++
          continue
        }
        
        validTiles++
        
        // æ”¶é›†æ ·æœ¬æ•°æ®ç”¨äºéªŒè¯
        if (samplePaths.length < 3) {
          samplePaths.push({
            ä½ç½®: `(${rowIndex},${colIndex})`,
            ç”Ÿç‰©ç¾¤ç³»: tile.biome,
            åœ°å½¢: tile.hill || 'æ— ',
            ç‰©ä½“: tile.object || 'æ— ',
            å¤‡æ³¨: 'è·¯å¾„éªŒè¯å·²ç§»è‡³mapç»„ä»¶'
          })
        }
      }
    }
    
    console.log('ğŸ“ˆ åœ°å—éªŒè¯ç»“æœ:', {
      æœ‰æ•ˆåœ°å—: validTiles,
      æ— æ•ˆåœ°å—: invalidTiles,
      éªŒè¯ç‡: `${((validTiles / (validTiles + invalidTiles)) * 100).toFixed(1)}%`
    })
    
    console.log('ğŸ–¼ï¸ æ ·æœ¬å›¾ç‰‡è·¯å¾„:', samplePaths)
    
    // éªŒè¯äººç‰©æ¨¡å‹
    this.validateCharacterRendering()
    
    console.log('âœ… åœ°å›¾æ¸²æŸ“éªŒè¯å®Œæˆ')
  },
  
  // éªŒè¯äººç‰©æ¨¡å‹æ¸²æŸ“
  validateCharacterRendering() {
    console.log('ğŸ‘¤ äººç‰©æ¨¡å‹æ¸²æŸ“éªŒè¯å¼€å§‹...')
    
    if (!this.characterPaths) {
      console.error('âŒ characterPathsæœªå®šä¹‰')
      return
    }
    
    console.log('ğŸ­ äººç‰©æ¨¡å‹è·¯å¾„çŠ¶æ€:', {
      èº«ä½“è·¯å¾„: this.characterPaths.body || 'æ— ',
      å¤´éƒ¨è·¯å¾„: this.characterPaths.head || 'æ— ',
      å¤´å‘è·¯å¾„: this.characterPaths.hair || 'æ— ',
      èƒ¡é¡»è·¯å¾„: this.characterPaths.beard || 'æ— '
    })
    
    // æ£€æŸ¥ç©å®¶ä½ç½®æ˜¯å¦æœ‰æ•ˆ
    const playerX = this.playerPosition?.x
    const playerY = this.playerPosition?.y
    const isValidPosition = playerX >= 0 && playerX < 5 && playerY >= 0 && playerY < 5
    
    console.log('ğŸ“ ç©å®¶ä½ç½®éªŒè¯:', {
      ä½ç½®: `(${playerX},${playerY})`,
      æ˜¯å¦æœ‰æ•ˆ: isValidPosition,
      åº”è¯¥æ˜¾ç¤ºäººç‰©: isValidPosition
    })
    
    if (isValidPosition) {
      const currentTile = this.terrainGrid[playerY][playerX]
      console.log('ğŸ¯ ç©å®¶å½“å‰åœ°å—:', currentTile)
    }
    
    console.log('âœ… äººç‰©æ¨¡å‹æ¸²æŸ“éªŒè¯å®Œæˆ')
  },
  
  // åˆå§‹åŒ–å“åº”å¼å¸ƒå±€
  initResponsiveLayout() {
    try {
      console.log('ğŸ“± åˆå§‹åŒ–å“åº”å¼å¸ƒå±€ç®¡ç†å™¨...')
      
      // è·å–è®¾å¤‡ä¿¡æ¯
      this.deviceInfo = responsiveManager.getDeviceInfo()
      
      // è·å–å„ç»„ä»¶çš„å“åº”å¼æ ·å¼
       this.responsiveStyles = {
         statusBar: responsiveManager.getComponentStyles('statusBar'),
         statusLabel: responsiveManager.getComponentStyles('statusLabel'),
         statusValue: responsiveManager.getComponentStyles('statusValue'),
         resourceBar: responsiveManager.getComponentStyles('resourceBar'),
         mapContainer: responsiveManager.getComponentStyles('mapContainer'),
         mapComponent: responsiveManager.getComponentStyles('mapComponent'),
         bottomNav: responsiveManager.getComponentStyles('bottomNav'),
         navBtn: responsiveManager.getComponentStyles('navBtn'),
         locationInfo: responsiveManager.getComponentStyles('locationInfo')
       }
      
      console.log('âœ… å“åº”å¼å¸ƒå±€åˆå§‹åŒ–å®Œæˆ:', {
        è®¾å¤‡ä¿¡æ¯: this.deviceInfo,
        åœ°å›¾å®¹å™¨å°ºå¯¸: this.responsiveStyles.mapContainer,
        åœ°å›¾ç¼©æ”¾: this.responsiveStyles.mapComponent.transform
      })
      
    } catch (error) {
      console.error('âŒ å“åº”å¼å¸ƒå±€åˆå§‹åŒ–å¤±è´¥:', error)
      // ä½¿ç”¨é»˜è®¤æ ·å¼é…ç½®
      this.responsiveStyles = {
        statusBar: {},
        resourceBar: {},
        mapContainer: { width: '350px', height: '350px' },
        mapComponent: { transform: 'scale(1)' },
        bottomNav: {},
        navBtn: {},
        locationInfo: {}
      }
    }
  },
  
  // åˆå§‹åŒ–åœ°å½¢ç½‘æ ¼æ•°æ®
  initializeTerrainGrid() {
    // ä¼˜å…ˆä½¿ç”¨preGeneratedTerrainæ•°æ®
    if (this.preGeneratedTerrain && this.preGeneratedTerrain.grid) {
      console.log('ğŸ—ºï¸ ä½¿ç”¨é¢„ç”Ÿæˆçš„åœ°å½¢æ•°æ®')
      this.terrainGrid = this.preGeneratedTerrain.grid
      
      // åŒæ­¥ç©å®¶ä½ç½®
      if (this.preGeneratedTerrain.playerPosition) {
        this.playerPosition = this.preGeneratedTerrain.playerPosition
      }
      
      // åŒæ­¥ç”Ÿç‰©ç¾¤ç³»
      if (this.preGeneratedTerrain.biome) {
        this.currentBiome = this.preGeneratedTerrain.biome
      }
      
      console.log('âœ… é¢„ç”Ÿæˆåœ°å½¢æ•°æ®åŠ è½½å®Œæˆ:', {
        ç½‘æ ¼å¤§å°: `${this.terrainGrid.length}x${this.terrainGrid[0].length}`,
        ç”Ÿç‰©ç¾¤ç³»: this.currentBiome,
        ç©å®¶ä½ç½®: this.playerPosition,
        æ ·æœ¬æ•°æ®: this.terrainGrid[0][0]
      })
      return
    }
    
    // å¦‚æœæ²¡æœ‰é¢„ç”Ÿæˆæ•°æ®ï¼Œä½¿ç”¨terrainGeneratorç”Ÿæˆ
    console.log('ğŸ² ä½¿ç”¨terrainGeneratorç”Ÿæˆéšæœºåœ°å½¢')
    try {
      const terrainData = terrainGenerator.generateTerrain(10, 10)
      if (terrainData && terrainData.grid) {
        this.terrainGrid = terrainData.grid
        this.currentBiome = terrainData.biome || 'TemperateForest'
        this.playerPosition = terrainData.playerPosition || { x: 2, y: 2 }
        
        console.log('âœ… terrainGeneratoråœ°å½¢ç”Ÿæˆå®Œæˆ:', {
          ç½‘æ ¼å¤§å°: `${this.terrainGrid.length}x${this.terrainGrid[0].length}`,
          ç”Ÿç‰©ç¾¤ç³»: this.currentBiome,
          ç©å®¶ä½ç½®: this.playerPosition,
          æ ·æœ¬æ•°æ®: this.terrainGrid[0][0]
        })
        return
      }
    } catch (error) {
      console.log('âŒ terrainGeneratorç”Ÿæˆå¤±è´¥:', error.message)
    }
    
    // æœ€åçš„å¤‡ç”¨æ–¹æ¡ˆï¼šç®€å•éšæœºç”Ÿæˆ
    console.log('ğŸ”„ ä½¿ç”¨å¤‡ç”¨éšæœºç”Ÿæˆæ–¹æ¡ˆ')
    const biomes = ['TemperateForest', 'BorealForest', 'TropicalRainforest', 'AridShrubland', 'Desert']
    const hills = [null, 'SmallHills', 'LargeHills', 'Mountains']
    const objects = [null, null, null, 'Town', 'AncientRoad']
    
    this.terrainGrid = []
    for (let i = 0; i < 5; i++) {
      const row = []
      for (let j = 0; j < 5; j++) {
        const tile = {
          biome: biomes[Math.floor(Math.random() * biomes.length)],
          hill: hills[Math.floor(Math.random() * hills.length)],
          object: objects[Math.floor(Math.random() * objects.length)]
        }
        row.push(tile)
      }
      this.terrainGrid.push(row)
    }
    
    this.currentBiome = 'TemperateForest'
    this.playerPosition = { x: 2, y: 2 }
    
    console.log('âœ… å¤‡ç”¨åœ°å½¢ç½‘æ ¼åˆå§‹åŒ–å®Œæˆ:', {
      ç½‘æ ¼å¤§å°: `${this.terrainGrid.length}x${this.terrainGrid[0].length}`,
      æ ·æœ¬æ•°æ®: this.terrainGrid[0][0]
    })
  },
  
  // è·å–åœ°å½¢å›¾ç‰‡è·¯å¾„
  getTerrainPath(biome) {
    const biomeMap = {
      'TemperateForest': 'common/world/Biomes/TemperateForest.png',
      'BorealForest': 'common/world/Biomes/BorealForest.png',
      'TropicalRainforest': 'common/world/Biomes/TropicalRainforest.png',
      'TropicalSwamp': 'common/world/Biomes/TropicalSwamp.png',
      'AridShrubland': 'common/world/Biomes/AridShrubland.png',
      'Desert': 'common/world/Biomes/Desert.png',
      'ExtremeDesert': 'common/world/Biomes/ExtremeDesert.png',
      'Tundra': 'common/world/Biomes/Tundra.png',
      'IceSheet': 'common/world/Biomes/IceSheet.png',
      'SeaIce': 'common/world/Biomes/IceSheet.png'
    }
    const path = biomeMap[biome] || 'common/world/Biomes/TemperateForest.png'
    return path
  },
  
  // è·å–åœ°å½¢ç‰¹å¾å›¾ç‰‡è·¯å¾„
  getFeaturePath(hill) {
    const hillMap = {
      'SmallHills': 'common/world/Hills/SmallHills.png',
      'LargeHills': 'common/world/Hills/LargeHills.png',
      'Mountains': 'common/world/Hills/Mountains.png',
      'ImpassableMountains': 'common/world/Hills/Impassable.png'
    }
    return hillMap[hill] || null
  },
  
  // è·å–åœ°å½¢ç‰©ä½“å›¾ç‰‡è·¯å¾„
  getObjectPath(object) {
    const objectMap = {
      'AncientRoad': 'common/world/WorldObjects/DefaultSettlement.png',
      'AbandonedSettlement': 'common/world/WorldObjects/DefaultSettlement.png',
      'ShrineOfNature': 'common/world/WorldObjects/DefaultSettlement.png',
      'Town': 'common/world/WorldObjects/Town.png',
      'Ambush': 'common/world/WorldObjects/Ambush.png',
      'Mechanoids': 'common/world/WorldObjects/Mechanoids.png'
    }
    return objectMap[object] || null
  },
  
  // å¤„ç†å›¾ç‰‡åŠ è½½é”™è¯¯
  handleImageError(event) {
    try {
      // æ£€æŸ¥äº‹ä»¶å¯¹è±¡æ˜¯å¦å®Œæ•´
      if (!event) {
        console.log('âš ï¸ å›¾ç‰‡åŠ è½½é”™è¯¯ï¼šäº‹ä»¶å¯¹è±¡ä¸ºç©ºï¼Œå¯èƒ½æ˜¯velaOSæ¡†æ¶é—®é¢˜')
        return
      }
      
      if (!event.target) {
        console.log('âš ï¸ å›¾ç‰‡åŠ è½½é”™è¯¯ï¼šäº‹ä»¶ç›®æ ‡ä¸ºç©ºï¼Œå°è¯•å…¶ä»–æ–¹å¼å¤„ç†')
        // å°è¯•é€šè¿‡äº‹ä»¶ç±»å‹åˆ¤æ–­
        if (event.type === 'error') {
          console.log('ğŸ” æ£€æµ‹åˆ°é”™è¯¯äº‹ä»¶ï¼Œä½†æ— æ³•è·å–ç›®æ ‡å…ƒç´ ')
        }
        return
      }
      
      // è¯¦ç»†æ—¥å¿—ï¼šè®°å½•å›¾ç‰‡åŠ è½½å¤±è´¥ä¿¡æ¯
      const imageSrc = event.target.src || 'æœªçŸ¥è·¯å¾„'
      const imageClass = event.target.className || 'æœªçŸ¥ç±»å‹'
      
      console.log('âŒ å›¾ç‰‡åŠ è½½å¤±è´¥:', {
        è·¯å¾„: imageSrc,
        ç±»å‹: imageClass,
        é”™è¯¯æ—¶é—´: new Date().toLocaleTimeString(),
        å…ƒç´ æ ‡ç­¾: event.target.tagName || 'æœªçŸ¥',
        äº‹ä»¶ç±»å‹: event.type || 'æœªçŸ¥'
      })
      
      // æ£€æŸ¥å¸¸è§çš„åŠ è½½å¤±è´¥åŸå› 
      if (imageSrc.includes('/common/')) {
        console.log('ğŸ” å¯èƒ½çš„å¤±è´¥åŸå› :')
        console.log('  1. æ–‡ä»¶è·¯å¾„ä¸å­˜åœ¨')
        console.log('  2. æ–‡ä»¶åå¤§å°å†™ä¸åŒ¹é…')
        console.log('  3. å›¾ç‰‡æ–‡ä»¶æŸåæˆ–æ ¼å¼ä¸æ”¯æŒ')
        console.log('  4. èµ„æºæœªæ­£ç¡®æ‰“åŒ…åˆ°buildç›®å½•')
      }
      
      // å¦‚æœæ˜¯äººç‰©æ¨¡å‹å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨é»˜è®¤å›¾ç‰‡
      if (imageSrc.includes('/common/human/')) {
        console.log('ğŸ”„ äººç‰©æ¨¡å‹å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨é»˜è®¤è·¯å¾„')
        
        // æ ¹æ®å›¾ç‰‡ç±»å‹è®¾ç½®é»˜è®¤è·¯å¾„
        if (imageClass === 'player-body') {
          event.target.src = 'common/human/bodies/Naked_Male_south.png'
          console.log('ğŸ­ ä½¿ç”¨é»˜è®¤èº«ä½“å›¾ç‰‡')
        } else if (imageClass === 'player-head') {
          event.target.src = 'common/human/heads/Male/Male_Average_Normal_south.png'
          console.log('ğŸ‘¤ ä½¿ç”¨é»˜è®¤å¤´éƒ¨å›¾ç‰‡')
        } else if (imageClass === 'player-hair') {
          console.log('ğŸ’‡ å¤´å‘å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œéšè—æ˜¾ç¤º')
          // ä½¿ç”¨showå±æ€§æ§åˆ¶æ˜¾ç¤ºéšè—ï¼Œè€Œä¸æ˜¯ç›´æ¥æ“ä½œstyle
        } else if (imageClass === 'player-beard') {
          console.log('ğŸ§” èƒ¡é¡»å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œéšè—æ˜¾ç¤º')
          // ä½¿ç”¨showå±æ€§æ§åˆ¶æ˜¾ç¤ºéšè—ï¼Œè€Œä¸æ˜¯ç›´æ¥æ“ä½œstyle
        }
      } else {
        // å›¾ç‰‡åŠ è½½å¤±è´¥æ—¶çš„å¤„ç†
        console.log('ğŸ–¼ï¸ å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œä½†ä¸ç›´æ¥æ“ä½œstyleå±æ€§')
      }
    } catch (error) {
      console.log('âŒ handleImageErrorå‡½æ•°æ‰§è¡Œå¼‚å¸¸:', error.message)
    }
  },
  
  // å¤„ç†æ¸¸æˆèœå•ç‚¹å‡»äº‹ä»¶
  handleMenuAction(action) {
    try {
      console.log('ğŸ® æ¸¸æˆèœå•ç‚¹å‡»:', action)
      
      switch (action) {
        case 'explore':
          console.log('ğŸ” æ¢ç´¢åŠŸèƒ½ - å¼€å‘ä¸­')
          // TODO: å®ç°æ¢ç´¢åŠŸèƒ½
          break
        case 'build':
          console.log('ğŸ—ï¸ å»ºé€ åŠŸèƒ½ - å¼€å‘ä¸­')
          // TODO: å®ç°å»ºé€ åŠŸèƒ½
          break
        case 'manage':
          console.log('ğŸ“‹ ç®¡ç†åŠŸèƒ½ - å¼€å‘ä¸­')
          // TODO: å®ç°ç®¡ç†åŠŸèƒ½
          break
        case 'combat':
          console.log('âš”ï¸ æˆ˜æ–—åŠŸèƒ½ - å¼€å‘ä¸­')
          // TODO: å®ç°æˆ˜æ–—åŠŸèƒ½
          break
        default:
          console.log('â“ æœªçŸ¥èœå•æ“ä½œ:', action)
      }
    } catch (error) {
      console.error('âŒ èœå•æ“ä½œå¤„ç†å¤±è´¥:', error)
    }
  },
  
  // æ˜¾ç¤ºå“åº”å¼æµ‹è¯•é¡µé¢
  showResponsiveTest() {
    try {
      console.log('ğŸ”§ è·³è½¬åˆ°å“åº”å¼æµ‹è¯•é¡µé¢...')
      router.push({
        uri: '/pages/responsive-test/responsive-test'
      })
    } catch (error) {
      console.error('âŒ è·³è½¬å“åº”å¼æµ‹è¯•é¡µé¢å¤±è´¥:', error)
    }
  }

}
</script>

<style>
.game-page {
  flex-direction: column;
  background-color: #2c2c2c;
  width: 100%;
  height: 100%;
  position: relative;
}

.status-bar {
  flex-direction: row;
  justify-content: space-around;
  background-color: rgba(0,0,0,0.9);
  border-bottom: 2px solid #8B4513;
  border-radius: 0 0 25px 25px;
}

.status-item {
  flex-direction: column;
  align-items: center;
  justify-content: center;
  flex: 1;
  padding: 5px;
}

.status-left {
  margin-top: 5px;
}

.status-center {
  margin-top: -5px;
}

.status-right {
  margin-top: 5px;
}

.status-label {
  font-size: 12px;
  color: #cccccc;
  text-align: center;
  margin-bottom: 3px;
}

.status-value {
  font-size: 14px;
  color: #ffffff;
  font-weight: bold;
  text-align: center;
}

/* èµ„æºçŠ¶æ€æ  */
.resource-bar {
  flex-direction: row;
  justify-content: space-around;
  background-color: rgba(139, 69, 19, 0.8);
  border-bottom: 1px solid #8B4513;
  border-radius: 12px;
}

.resource-item {
  flex-direction: row;
  align-items: center;
}

.resource-label {
  font-size: 11px;
  color: #ffffff;
  margin-right: 4px;
}

.resource-value {
  font-size: 13px;
  color: #FFD700;
  font-weight: bold;
}

/* ä¸»æ¸¸æˆåŒºåŸŸ - å·¦å³å¸ƒå±€ */
.main-game-area {
  flex: 1;
  flex-direction: row;
  align-items: stretch;
  justify-content: space-between;
  margin: 5px 0 60px 0;
  height: 100%;
  border: 2px solid #87CEEB;
  border-radius: 12px;
  padding: 5px;
}

/* åœ°å›¾æ˜¾ç¤ºå®¹å™¨ - å“åº”å¼å°ºå¯¸ï¼Œæ”¯æŒç¼©æ”¾ */
.map-display-container {
  flex: 3;
  flex-direction: column;
  align-items: stretch;
  justify-content: stretch;
  background-color: transparent;
  overflow: hidden;
  position: relative;
  margin-right: 5px;
  height: 100%;
}

/* æ¸¸æˆèœå• */
.game-menu {
  flex: 1;
  flex-direction: column;
  align-items: stretch;
  justify-content: space-between;
  background-color: rgba(0, 0, 0, 0.8);
  border-radius: 12px;
  padding: 5px;
  height: 100%;
}

.menu-item {
  flex: 1;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  background-color: rgba(139, 69, 19, 0.6);
  border: 1px solid #8B4513;
  border-radius: 8px;
  margin-bottom: 3px;
  padding: 8px;
}


.menu-icon {
  width: 24px;
  height: 24px;
  margin-bottom: 3px;
}

.menu-text {
  font-size: 12px;
  color: #ffffff;
  text-align: center;
  font-weight: bold;
}

/* åœ°å›¾ç»„ä»¶æ ·å¼ - å¯ç¼©æ”¾çš„å®¹å™¨ */
.map-component {
  width: 100%;
  height: 100%;
  transform-origin: center center;
  position: relative;
}



/* åœ°å½¢ç½‘æ ¼ - CSS Gridè‡ªé€‚åº”å¸ƒå±€ */
.terrain-grid {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  display: grid;
  grid-template-rows: repeat(10, 1fr);
  gap: 1px;
  background-color: transparent;
  padding: 2px;
  margin: 0;
}

.terrain-row {
  display: grid;
  grid-template-columns: repeat(10, 1fr);
  gap: 1px;
  width: 100%;
  height: 100%;
  margin: 0;
  padding: 0;
}

.tile-container {
  position: relative;
  width: 100%;
  height: 100%;
  margin: 0;
  padding: 0;
  border: none;
  background-color: transparent;
  aspect-ratio: 1;
}

.terrain-image {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.player-character {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  width: 100%;
  height: 100%;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}

.character-symbol {
  color: #00ff00;
  font-size: 20px;
  font-weight: bold;
  text-align: center;
  background-color: rgba(0, 0, 0, 0.7);
  border-radius: 50%;
  width: 24px;
  height: 24px;
  line-height: 24px;
}


.terrain-info-text {
  color: #ffffff;
  font-size: 12px;
  position: absolute;
  top: 5px;
  left: 5px;
}

.player-character-display {
  position: absolute;
  left: 50%;
  top: 50%;
  width: 96px;
  height: 96px;
  margin-left: -48px;
  margin-top: -48px;
}


.player-name-text {
  color: #ffffff;
  font-size: 10px;
  position: absolute;
  top: 98px;
  left: 0;
  width: 96px;
  text-align: center;
}



/* æ¸¸æˆä¸»ç•Œé¢æ ·å¼ */
.game-terrain-grid {
  position: absolute;
  top: 150px;
  left: 100px;
  width: 200px;
  height: 200px;
}

.terrain-tile {
  position: absolute;
  overflow: hidden;
}

.player-character {
  position: absolute;
  width: 32px;
  height: 32px;
  left: 50%;
  top: 50%;
  margin-left: -16px;
  margin-top: -16px;
}

.player-body,
.player-head,
.player-hair,
.player-beard {
  position: absolute;
  width: 32px;
  height: 32px;
  object-fit: contain;
}

.player-body {
  z-index: 1;
}

.player-head {
  z-index: 2;
}

.player-hair {
  z-index: 3;
}

.player-beard {
  z-index: 4;
}



/* åº•éƒ¨å¯¼èˆª */
.bottom-nav {
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  height: 50px;
  flex-direction: row;
  justify-content: center;
  align-items: center;
  background-color: rgba(0,0,0,0.9);
  border-top: 2px solid #8B4513;
  border-radius: 25px 25px 0 0;
  z-index: 20;
  padding: 0 20px;
}

.nav-btn {
  border-radius: 15px;
  background-color: rgba(139, 69, 19, 0.8);
  color: #ffffff;
  border: 1px solid #8B4513;
  margin: 0 5px;
  height: 35px;
  padding: 0 10px;
}

.nav-btn.primary {
  background-color: #32CD32;
  border-color: #228B22;
}

.nav-btn.auto-move-on {
  background-color: #FF6347;
  border-color: #DC143C;
  color: #ffffff;
}

.nav-btn.auto-move-off {
  background-color: #4682B4;
  border-color: #4169E1;
  color: #ffffff;
}

/* è°ƒè¯•ä¿¡æ¯æ ·å¼ */
.debug-info {
  position: absolute;
  top: 0;
  left: 0;
  color: #FF0000;
  font-size: 10px;
  font-weight: bold;
  background-color: rgba(255, 255, 255, 0.8);
  padding: 2px 4px;
  border-radius: 3px;
  z-index: 1000;
  pointer-events: none;
}

</style>